{% extends "base.html" %}

{% block title %}Dashboard - CPA WorkflowPilot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard Overview</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('create_project') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> New Project
            </a>
            <a href="{{ url_for('create_task') }}" class="btn btn-outline-primary">
                <i class="bi bi-plus-circle"></i> New Task
            </a>
        </div>
    </div>
</div>

<!-- Critical Alerts -->
{% if overdue_tasks > 0 or today_tasks > 0 %}
<div class="row mb-4">
    <div class="col-12">
        {% if overdue_tasks > 0 %}
        <div class="alert alert-danger d-flex align-items-center mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>Urgent:</strong> You have {{ overdue_tasks }} overdue task{{ 's' if overdue_tasks != 1 else '' }}.
                <a href="{{ url_for('tasks', overdue='true') }}" class="alert-link">View overdue tasks</a>
            </div>
        </div>
        {% endif %}
        
        {% if today_tasks > 0 %}
        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
            <i class="bi bi-clock-fill me-2"></i>
            <div>
                <strong>Today:</strong> {{ today_tasks }} task{{ 's' if today_tasks != 1 else '' }} due today.
                <a href="{{ url_for('tasks', due_date='today') }}" class="alert-link">View today's tasks</a>
            </div>
        </div>
        {% endif %}
        
        {% if due_this_week > 5 %}
        <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
            <i class="bi bi-calendar-week-fill me-2"></i>
            <div>
                <strong>This Week:</strong> {{ due_this_week }} tasks due this week. Plan your schedule accordingly.
                <a href="{{ url_for('calendar_view') }}" class="alert-link">View calendar</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- KPI Cards Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-4 border-primary shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">Active Projects</div>
                        <div class="h4 mb-0 fw-bold text-gray-800">{{ projects|length }}</div>
                        <small class="text-muted">{{ active_clients }} active clients</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-folder text-primary" style="font-size: 2.5rem; opacity: 0.8;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-4 border-success shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">Task Progress</div>
                        <div class="h4 mb-0 fw-bold text-gray-800">{{ completed_tasks }}/{{ total_tasks }}</div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 }}%"></div>
                        </div>
                        <small class="text-muted">{{ "%.1f"|format(completed_tasks / total_tasks * 100 if total_tasks > 0 else 0) }}% complete</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-check-circle text-success" style="font-size: 2.5rem; opacity: 0.8;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-4 border-warning shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">Overdue Tasks</div>
                        <div class="h4 mb-0 fw-bold text-gray-800">{{ overdue_tasks }}</div>
                        <small class="text-muted">Need immediate attention</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2.5rem; opacity: 0.8;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-4 border-info shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-info text-uppercase mb-1">Recent Activity</div>
                        <div class="h4 mb-0 fw-bold text-gray-800">{{ recent_tasks }}</div>
                        <small class="text-muted">Tasks created this week</small>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-activity text-info" style="font-size: 2.5rem; opacity: 0.8;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Task Status Distribution</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Priority Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Row -->
<div class="row">
    <!-- Upcoming Deadlines -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 fw-bold text-primary">Upcoming Deadlines</h6>
                <a href="{{ url_for('tasks', overdue='false') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if upcoming_tasks %}
                    <div class="list-group list-group-flush">
                        {% for task in upcoming_tasks %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.project %}
                                        <p class="mb-1 text-muted small">{{ task.project.client_name }} - {{ task.project.name }}</p>
                                    {% else %}
                                        <p class="mb-1 text-muted small"><span class="badge bg-info">Independent Task</span></p>
                                    {% endif %}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar-event"></i> 
                                        Due {{ task.due_date.strftime('%m/%d/%Y') }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    {% if task.priority == 'High' %}
                                        <span class="badge bg-danger">{{ task.priority }}</span>
                                    {% elif task.priority == 'Medium' %}
                                        <span class="badge bg-warning">{{ task.priority }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ task.priority }}</span>
                                    {% endif %}
                                    {% if task.assignee %}
                                        <br><small class="text-muted">{{ task.assignee.name }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-check" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-2">No upcoming deadlines in the next 7 days</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Team Workload -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Team Workload</h6>
            </div>
            <div class="card-body">
                {% if user_workload %}
                    {% for user, count in user_workload.items() %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">{{ user }}</span>
                            <span class="badge bg-primary">{{ count }} active tasks</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            {% set max_tasks = user_workload.values()|max if user_workload.values() else 1 %}
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ (count / max_tasks * 100) if max_tasks > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-people" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-2">No active task assignments</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Projects Table -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 fw-bold text-primary">Active Projects</h6>
                <a href="{{ url_for('projects') }}" class="btn btn-sm btn-outline-primary">View All Projects</a>
            </div>
            <div class="card-body">
                {% if projects %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Client</th>
                                <th>Project</th>
                                <th>Template</th>
                                <th>Start Date</th>
                                <th>Progress</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('view_client', id=project.client_id) }}" class="text-decoration-none">
                                        <i class="bi bi-building"></i> {{ project.client_name }}
                                    </a>
                                    {% if project.client %}
                                        <br><small class="text-muted">{{ project.client.entity_type }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ project.name }}</td>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        {{ project.template_origin.name if project.template_origin else 'Custom' }}
                                    </span>
                                </td>
                                <td>{{ project.start_date.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    {% set completed_tasks = project.tasks|selectattr('status', 'equalto', 'Completed')|list|length %}
                                    {% set total_tasks = project.tasks|length %}
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ completed_tasks }}/{{ total_tasks }}</span>
                                        <div class="progress flex-grow-1" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 }}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if project.priority == 'High' %}
                                        <span class="badge bg-danger">{{ project.priority }}</span>
                                    {% elif project.priority == 'Medium' %}
                                        <span class="badge bg-warning">{{ project.priority }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ project.priority }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('view_project', id=project.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-folder-plus" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h5 class="mt-3">No Active Projects</h5>
                    <p>Get started by creating your first project</p>
                    <a href="{{ url_for('create_project') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create Project
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Task Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Not Started', 'In Progress', 'Needs Review', 'Completed'],
        datasets: [{
            data: [
                {{ task_status_data['Not Started'] }},
                {{ task_status_data['In Progress'] }},
                {{ task_status_data['Needs Review'] }},
                {{ task_status_data['Completed'] }}
            ],
            backgroundColor: [
                '#6c757d',  // Gray for Not Started
                '#0d6efd',  // Blue for In Progress
                '#ffc107',  // Yellow for Needs Review
                '#198754'   // Green for Completed
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});

// Priority Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
const priorityChart = new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: ['High', 'Medium', 'Low'],
        datasets: [{
            label: 'Tasks',
            data: [
                {{ priority_data['High'] }},
                {{ priority_data['Medium'] }},
                {{ priority_data['Low'] }}
            ],
            backgroundColor: [
                '#dc3545',  // Red for High
                '#ffc107',  // Yellow for Medium
                '#198754'   // Green for Low
            ],
            borderColor: [
                '#dc3545',
                '#ffc107',
                '#198754'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}