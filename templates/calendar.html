{% extends "base.html" %}

{% block title %}Calendar - CPA WorkflowPilot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Calendar View</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('create_task') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> New Task
            </a>
            <a href="{{ url_for('tasks') }}" class="btn btn-outline-secondary">
                <i class="bi bi-list-task"></i> Task List
            </a>
        </div>
    </div>
</div>

<!-- Calendar Controls -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" id="prev-month">
                <i class="bi bi-chevron-left"></i> Previous
            </button>
            <button type="button" class="btn btn-outline-primary" id="today-btn">Today</button>
            <button type="button" class="btn btn-outline-primary" id="next-month">
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <span class="ms-3 h4" id="current-month">{{ current_date.strftime('%B %Y') }}</span>
    </div>
    <div class="col-md-4">
        <div class="text-end">
            <div class="legend">
                <span class="badge bg-danger me-2">Overdue</span>
                <span class="badge bg-warning me-2">Due Soon</span>
                <span class="badge bg-primary me-2">Scheduled</span>
                <span class="badge bg-success">Completed</span>
            </div>
        </div>
    </div>
</div>

<!-- Calendar -->
<div class="card">
    <div class="card-body">
        <div id="calendar-container">
            <table class="table table-bordered calendar-table" id="calendar">
                <thead>
                    <tr class="table-light">
                        <th class="text-center">Sunday</th>
                        <th class="text-center">Monday</th>
                        <th class="text-center">Tuesday</th>
                        <th class="text-center">Wednesday</th>
                        <th class="text-center">Thursday</th>
                        <th class="text-center">Friday</th>
                        <th class="text-center">Saturday</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <!-- Calendar days will be generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">Tasks for <span id="modal-date"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-tasks">
                <!-- Tasks will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('create_task') }}" class="btn btn-primary" id="add-task-link">Add New Task</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.calendar-table {
    table-layout: fixed;
}

.calendar-table th, 
.calendar-table td {
    height: 120px;
    vertical-align: top;
    padding: 8px;
    border: 1px solid #dee2e6;
    width: 14.28%;
}

.calendar-day {
    position: relative;
    height: 100%;
    cursor: pointer;
}

.calendar-day:hover {
    background-color: #f8f9fa;
}

.calendar-day-number {
    font-weight: bold;
    margin-bottom: 5px;
}

.other-month {
    color: #6c757d;
    background-color: #f8f9fa;
}

.today {
    background-color: rgba(13, 110, 253, 0.1);
    border: 2px solid var(--bs-primary);
}

.task-item {
    background: var(--primary-blue);
    color: white;
    padding: 2px 6px;
    margin: 1px 0;
    border-radius: 3px;
    font-size: 11px;
    display: block;
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-item:hover {
    color: white;
    opacity: 0.8;
}

.task-item.overdue {
    background: var(--danger-red);
}

.task-item.due-soon {
    background: var(--warning-orange);
}

.task-item.completed {
    background: var(--success-green);
    opacity: 0.7;
}

.task-count {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--primary-blue);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
// Calendar data from server
const calendarData = {{ calendar_data|tojson }};
let currentDate = new Date({{ current_date.year }}, {{ current_date.month - 1 }}, {{ current_date.day }});

// Initialize calendar
function initCalendar() {
    generateCalendar(currentDate);
}

// Generate calendar for given month
function generateCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // Update month display
    document.getElementById('current-month').textContent = 
        date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Get previous month info for padding
    const prevMonth = new Date(year, month - 1, 0);
    const daysInPrevMonth = prevMonth.getDate();
    
    const calendarBody = document.getElementById('calendar-body');
    calendarBody.innerHTML = '';
    
    let dayCount = 1;
    let nextMonthDay = 1;
    
    // Generate 6 weeks of calendar
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('td');
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            let dayNumber;
            let isCurrentMonth = true;
            let cellDate;
            
            if (week === 0 && day < startingDayOfWeek) {
                // Previous month days
                dayNumber = daysInPrevMonth - startingDayOfWeek + day + 1;
                cellDate = new Date(year, month - 1, dayNumber);
                isCurrentMonth = false;
            } else if (dayCount <= daysInMonth) {
                // Current month days
                dayNumber = dayCount;
                cellDate = new Date(year, month, dayNumber);
                dayCount++;
            } else {
                // Next month days
                dayNumber = nextMonthDay;
                cellDate = new Date(year, month + 1, dayNumber);
                nextMonthDay++;
                isCurrentMonth = false;
            }
            
            // Add day number
            const dayNumberDiv = document.createElement('div');
            dayNumberDiv.className = 'calendar-day-number';
            dayNumberDiv.textContent = dayNumber;
            dayDiv.appendChild(dayNumberDiv);
            
            // Style current month vs other months
            if (!isCurrentMonth) {
                cell.className = 'other-month';
            }
            
            // Highlight today
            const today = new Date();
            if (cellDate.toDateString() === today.toDateString()) {
                cell.classList.add('today');
            }
            
            // Add tasks for this day
            const dateStr = cellDate.toISOString().split('T')[0];
            if (calendarData[dateStr]) {
                const tasks = calendarData[dateStr];
                let visibleTasks = 0;
                const maxVisible = 3;
                
                tasks.forEach((task, index) => {
                    if (index < maxVisible) {
                        const taskDiv = document.createElement('a');
                        taskDiv.className = 'task-item';
                        taskDiv.href = `/tasks/${task.id}`;
                        taskDiv.textContent = task.title;
                        taskDiv.title = `${task.title} - ${task.project_name || 'Independent Task'}`;
                        
                        // Add task status classes
                        if (task.is_overdue && task.status !== 'Completed') {
                            taskDiv.classList.add('overdue');
                        } else if (task.is_due_soon && task.status !== 'Completed') {
                            taskDiv.classList.add('due-soon');
                        } else if (task.status === 'Completed') {
                            taskDiv.classList.add('completed');
                        }
                        
                        dayDiv.appendChild(taskDiv);
                        visibleTasks++;
                    }
                });
                
                // Add task count if there are more tasks
                if (tasks.length > maxVisible) {
                    const countDiv = document.createElement('div');
                    countDiv.className = 'task-count';
                    countDiv.textContent = `+${tasks.length - maxVisible}`;
                    dayDiv.appendChild(countDiv);
                }
            }
            
            // Add click handler to show tasks
            dayDiv.addEventListener('click', () => showTasksForDate(cellDate));
            
            cell.appendChild(dayDiv);
            row.appendChild(cell);
        }
        
        calendarBody.appendChild(row);
    }
}

// Show tasks for selected date
function showTasksForDate(date) {
    const dateStr = date.toISOString().split('T')[0];
    const tasks = calendarData[dateStr] || [];
    
    document.getElementById('modal-date').textContent = 
        date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    const modalTasks = document.getElementById('modal-tasks');
    
    if (tasks.length === 0) {
        modalTasks.innerHTML = '<p class="text-muted">No tasks scheduled for this date.</p>';
    } else {
        let html = '<div class="list-group list-group-flush">';
        tasks.forEach(task => {
            let badgeClass = 'bg-primary';
            let badgeText = task.status;
            
            if (task.is_overdue && task.status !== 'Completed') {
                badgeClass = 'bg-danger';
                badgeText = 'Overdue';
            } else if (task.is_due_soon && task.status !== 'Completed') {
                badgeClass = 'bg-warning';
                badgeText = 'Due Soon';
            } else if (task.status === 'Completed') {
                badgeClass = 'bg-success';
            }
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="/tasks/${task.id}" class="text-decoration-none">${task.title}</a>
                            </h6>
                            <p class="mb-1 text-muted small">
                                ${task.project_name ? `${task.project_name}` : 'Independent Task'}
                                ${task.assignee_name ? ` • Assigned to ${task.assignee_name}` : ''}
                            </p>
                            ${task.description ? `<p class="mb-1 text-muted small">${task.description}</p>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            ${task.priority ? `<br><small class="text-muted">${task.priority} Priority</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        modalTasks.innerHTML = html;
    }
    
    // Update "Add New Task" link with selected date
    const addTaskLink = document.getElementById('add-task-link');
    addTaskLink.href = `/tasks/create?due_date=${dateStr}`;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('taskModal')).show();
}

// Calendar navigation
document.getElementById('prev-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    // Reload calendar data for new month
    window.location.href = `/calendar?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`;
});

document.getElementById('next-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    // Reload calendar data for new month
    window.location.href = `/calendar?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`;
});

document.getElementById('today-btn').addEventListener('click', () => {
    const today = new Date();
    window.location.href = `/calendar?year=${today.getFullYear()}&month=${today.getMonth() + 1}`;
});

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', initCalendar);
</script>
{% endblock %}