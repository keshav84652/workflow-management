{% extends "base.html" %}

{% block title %}Edit {{ project.name }} - CPA WorkflowPilot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Edit Project</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('view_project', id=project.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Project
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Project Information</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="name" class="form-label">Project Name *</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ project.name }}" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ project.start_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date" 
                                       value="{{ project.due_date.strftime('%Y-%m-%d') if project.due_date else '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="High" {% if project.priority == 'High' %}selected{% endif %}>High</option>
                                    <option value="Medium" {% if project.priority == 'Medium' %}selected{% endif %}>Medium</option>
                                    <option value="Low" {% if project.priority == 'Low' %}selected{% endif %}>Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="Active" {% if project.status == 'Active' %}selected{% endif %}>Active</option>
                                    <option value="Completed" {% if project.status == 'Completed' %}selected{% endif %}>Completed</option>
                                    <option value="On Hold" {% if project.status == 'On Hold' %}selected{% endif %}>On Hold</option>
                                    <option value="Cancelled" {% if project.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('view_project', id=project.id) }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Project Tasks Management -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Project Tasks</h5>
                <a href="{{ url_for('create_task') }}?project_id={{ project.id }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Task
                </a>
            </div>
            <div class="card-body">
                {% if project.tasks %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Priority</th>
                                <th>Due Date</th>
                                <th>Assignee</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in project.tasks %}
                            <tr class="{% if task.is_overdue %}task-overdue{% endif %}">
                                <td>
                                    <strong>{{ task.title }}</strong>
                                    {% if task.description %}
                                        <br><small class="text-muted">{{ task.description[:60] }}{% if task.description|length > 60 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.priority == 'High' %}
                                        <span class="badge bg-danger">{{ task.priority }}</span>
                                    {% elif task.priority == 'Medium' %}
                                        <span class="badge bg-warning">{{ task.priority }}</span>
                                    {% elif task.priority == 'Low' %}
                                        <span class="badge bg-success">{{ task.priority }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Medium</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.due_date %}
                                        {% if task.is_overdue %}
                                            <span class="text-danger fw-bold">
                                                {{ task.due_date.strftime('%Y-%m-%d') }}
                                            </span>
                                            <br><span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle"></i> Overdue
                                            </span>
                                        {% elif task.is_due_soon %}
                                            <span class="text-warning fw-bold">
                                                {{ task.due_date.strftime('%Y-%m-%d') }}
                                            </span>
                                            <br><span class="badge bg-warning">
                                                <i class="bi bi-clock"></i> Due Soon
                                            </span>
                                        {% else %}
                                            {{ task.due_date.strftime('%Y-%m-%d') }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.assignee %}
                                        <i class="bi bi-person-circle"></i> {{ task.assignee.name }}
                                    {% else %}
                                        <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm status-select" data-task-id="{{ task.id }}">
                                        <option value="Not Started" {% if task.status == 'Not Started' %}selected{% endif %}>Not Started</option>
                                        <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                        <option value="Needs Review" {% if task.status == 'Needs Review' %}selected{% endif %}>Needs Review</option>
                                        <option value="Completed" {% if task.status == 'Completed' %}selected{% endif %}>Completed</option>
                                    </select>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_task', id=task.id) }}" class="btn btn-sm btn-outline-primary" title="View Task">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('edit_task', id=task.id) }}" class="btn btn-sm btn-outline-secondary" title="Edit Task">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" title="Delete Task"
                                                onclick="deleteTask({{ task.id }}, '{{ task.title }}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions for Tasks -->
                <div class="mt-3">
                    <h6>Bulk Actions</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="bulkAssignTasks()">
                            <i class="bi bi-person-check"></i> Bulk Assign
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="bulkStatusUpdate('In Progress')">
                            <i class="bi bi-play"></i> Mark as In Progress
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="bulkStatusUpdate('Completed')">
                            <i class="bi bi-check-circle"></i> Mark as Completed
                        </button>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-list-task text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No tasks yet</h5>
                    <p class="text-muted">Add tasks to this project to track progress and assignments.</p>
                    <a href="{{ url_for('create_task') }}?project_id={{ project.id }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create First Task
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Client Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Client Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">CLIENT</label>
                    <div>
                        <a href="{{ url_for('view_client', id=project.client_id) }}" class="text-decoration-none">
                            <i class="bi bi-building"></i> {{ project.client_name }}
                        </a>
                        {% if project.client %}
                            <br><small class="text-muted">{{ project.client.entity_type }}</small>
                        {% endif %}
                    </div>
                </div>
                
                {% if project.template_origin %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">TEMPLATE ORIGIN</label>
                    <div><span class="badge bg-light text-dark">{{ project.template_origin.name }}</span></div>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">CREATED</label>
                    <div>{{ project.created_at.strftime('%m/%d/%Y %I:%M %p') if project.created_at else 'N/A' }}</div>
                </div>
                
                {% set completed_tasks = project.tasks|selectattr('status', 'equalto', 'Completed')|list|length %}
                {% set total_tasks = project.tasks|length %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">PROGRESS</label>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 }}%"></div>
                    </div>
                    <small class="text-muted">{{ completed_tasks }}/{{ total_tasks }} tasks completed</small>
                </div>
            </div>
        </div>
        
        <!-- Project Limits -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Important Notes</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> Changing the start date may affect task due dates if they were calculated from the template.
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Client Assignment:</strong> The client assignment cannot be changed after project creation. Create a new project if needed.
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('view_client', id=project.client_id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-building"></i> View Client
                    </a>
                    <a href="{{ url_for('create_task') }}?project_id={{ project.id }}" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Add Task
                    </a>
                    <a href="{{ url_for('projects') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-list"></i> All Projects
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Task status update functionality
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', function() {
        const taskId = this.dataset.taskId;
        const newStatus = this.value;
        
        fetch(`/tasks/${taskId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating task status');
            }
        })
        .catch(error => {
            alert('Error updating task status');
            console.error('Error:', error);
        });
    });
});

// Delete task functionality
function deleteTask(taskId, taskTitle) {
    if (confirm(`Are you sure you want to delete the task "${taskTitle}"? This action cannot be undone.`)) {
        fetch(`/tasks/${taskId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting task: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Network error occurred while deleting task');
            console.error('Error:', error);
        });
    }
}

// Bulk assign tasks
function bulkAssignTasks() {
    // Get all tasks for this project
    const projectTasks = {{ project.tasks|map(attribute='id')|list|tojson }};
    
    if (projectTasks.length === 0) {
        alert('No tasks available to assign');
        return;
    }
    
    // Get available users
    const users = {{ users|map(attribute='id')|list|tojson }};
    const userNames = {{ users|map(attribute='name')|list|tojson }};
    
    // Create a modal-like prompt for user selection
    let userOptions = '';
    for (let i = 0; i < users.length; i++) {
        userOptions += `${i + 1}. ${userNames[i]}\n`;
    }
    
    const userChoice = prompt(
        `Select a user to assign all project tasks to:\n\n${userOptions}\n\nEnter the number (1-${users.length}):`
    );
    
    if (userChoice && !isNaN(userChoice)) {
        const userIndex = parseInt(userChoice) - 1;
        if (userIndex >= 0 && userIndex < users.length) {
            const selectedUserId = users[userIndex];
            const selectedUserName = userNames[userIndex];
            
            if (confirm(`Assign all ${projectTasks.length} tasks to ${selectedUserName}?`)) {
                // Bulk assign tasks
                fetch('/tasks/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        task_ids: projectTasks.map(String), 
                        assignee_id: selectedUserId 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error assigning tasks: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Network error occurred');
                });
            }
        } else {
            alert('Invalid selection');
        }
    }
}

// Bulk status update
function bulkStatusUpdate(status) {
    const projectTasks = {{ project.tasks|map(attribute='id')|list|tojson }};
    
    if (projectTasks.length === 0) {
        alert('No tasks available to update');
        return;
    }
    
    if (confirm(`Update all ${projectTasks.length} project tasks to "${status}" status?`)) {
        fetch('/tasks/bulk-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                task_ids: projectTasks.map(String), 
                status: status 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating tasks: ' + data.message);
            }
        })
        .catch(error => {
            alert('Network error occurred');
        });
    }
}
</script>
{% endblock %}