{% extends "base/base_modern.html" %}
{% set active_page = "checklists" %}

{% block title %}{{ checklist.name }} - {{ checklist.client.name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-1">
            <a href="{{ url_for('documents.document_checklists') }}" class="hover:text-cpa-blue">Checklists</a>
            <i class="bi bi-chevron-right"></i>
            <span>{{ checklist.client.name }}</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">{{ checklist.name }}</h1>
    </div>
    <div class="flex space-x-3">
        <a href="{{ url_for('documents.edit_checklist', checklist_id=checklist.id) }}" 
           class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-cpa-navy transition-colors">
            <i class="bi bi-pencil mr-2"></i>
            Edit Checklist
        </a>
        <a href="{{ url_for('clients.client_access_setup', client_id=checklist.client_id) }}" 
           class="inline-flex items-center px-4 py-2 bg-cpa-green text-white rounded-lg hover:bg-green-600 transition-colors">
            <i class="bi bi-person-circle mr-2"></i>
            Setup Portal Access
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-gray-900">{{ checklist.items|length }}</p>
            <p class="text-xs text-gray-600">Total</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-amber-600">{{ checklist.items|selectattr('status', 'equalto', 'pending')|list|length }}</p>
            <p class="text-xs text-gray-600">Pending</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-cpa-green">{{ checklist.items|selectattr('status', 'equalto', 'uploaded')|list|length }}</p>
            <p class="text-xs text-gray-600">Uploaded</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-cpa-blue">{{ "%.0f"|format(checklist.progress_percentage) }}%</p>
            <p class="text-xs text-gray-600">Complete</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2">
        <!-- Document Status -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 mb-6">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-900">Document Status</h2>
            </div>
            <!-- Bulk Actions Bar -->
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="analyzeAllDocuments()" 
                                class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                            <i class="bi bi-robot mr-2"></i>
                            Analyze All Documents
                        </button>
                        <button onclick="exportAllDocuments()" 
                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            <i class="bi bi-file-earmark-arrow-down mr-2"></i>
                            Export Analysis
                        </button>
                        <div class="flex items-center space-x-2">
                            <button id="incomeWorksheetBtn" onclick="generateIncomeWorksheet()" 
                                    class="inline-flex items-center px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors">
                                <i class="bi bi-file-earmark-spreadsheet mr-2"></i>
                                <span id="incomeWorksheetBtnText">Income Worksheet</span>
                            </button>
                            <div id="worksheetStatus" class="hidden">
                                <button onclick="downloadSavedWorksheet()" 
                                        class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer"
                                        title="Click to download saved worksheet">
                                    <i class="bi bi-check-circle mr-1"></i>
                                    <span id="worksheetStatusText">Saved</span>
                                </button>
                            </div>
                        </div>
                        <button onclick="generateWorkpaper()" 
                                class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            <i class="bi bi-file-earmark-pdf mr-2"></i>
                            Generate Workpaper
                        </button>
                    </div>
                    <div id="bulkProgress" class="hidden">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"></div>
                            <span class="text-sm text-gray-600">Processing documents...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents List -->
            <div class="p-4">
                <div class="space-y-4">
                    {% for item in checklist.items %}
                    {% if item.status == 'uploaded' %}
                    {% set documents = item.client_documents|list %}
                    {% if documents %}
                    {% for document in documents %}
                    <div class="border border-gray-200 rounded-lg">
                        <!-- Document Header (Clickable) -->
                        <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors" 
                             onclick="toggleDocumentExpansion({{ document.id }})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <i id="expand-icon-{{ document.id }}" class="bi bi-chevron-right text-gray-400 mr-2 transition-transform"></i>
                                        <div>
                                            <h4 class="font-medium text-gray-900">{{ document.original_filename }}</h4>
                                            <p class="text-sm text-gray-500">{{ item.title }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        {% if document.ai_analysis_completed %}
                                        <span id="analysis-status-{{ document.id }}" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                            <i class="bi bi-check-circle mr-1"></i>
                                            Analyzed
                                        </span>
                                        {% if document.ai_document_type %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                            {{ document.ai_document_type }}
                                        </span>
                                        {% endif %}
                                        {% else %}
                                        <span id="analysis-status-{{ document.id }}" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                            Not Analyzed
                                        </span>
                                        {% endif %}
                                        {% if item.is_required %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                            Required
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">{{ document.uploaded_at.strftime('%m/%d/%Y %I:%M %p') }}</span>
                                    <a href="{{ url_for('documents.download_document', document_id=document.id) }}" 
                                       class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded text-xs hover:bg-cpa-navy transition-colors">
                                        <i class="bi bi-download mr-1"></i>
                                        Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expandable Content -->
                        <div id="document-content-{{ document.id }}" class="hidden border-t border-gray-200 bg-gray-50">
                            <div class="p-4">
                                <div id="document-analysis-{{ document.id }}">
                                    {% if document.ai_analysis_completed and document.ai_analysis_results %}
                                    <!-- Show cached analysis results in detailed format -->
                                    <div id="cached-analysis-{{ document.id }}">
                                        <script>
                                            // Load and display cached analysis on page load
                                            document.addEventListener('DOMContentLoaded', function() {
                                                loadCachedAnalysis({{ document.id }});
                                            });
                                        </script>
                                    </div>
                                    {% else %}
                                    <!-- Show placeholder for unanalyzed documents -->
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="bi bi-file-earmark-text text-2xl mb-2"></i>
                                        <p>Click "Analyze All Documents" to process this document</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Pending Items -->
                {% set pending_items = checklist.items|selectattr('status', 'ne', 'uploaded')|list %}
                {% if pending_items %}
                <div class="mt-8">
                    <h4 class="font-medium text-gray-900 mb-4">Pending Items</h4>
                    <div class="space-y-2">
                        {% for item in pending_items %}
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-medium text-gray-900">{{ item.title }}</h5>
                                    {% if item.description %}
                                    <p class="text-sm text-gray-500">{{ item.description }}</p>
                                    {% endif %}
                                </div>
                                <div class="flex items-center space-x-2">
                                    {% if item.is_required %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                        Required
                                    </span>
                                    {% endif %}
                                    {% if item.status == 'pending' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-clock mr-1"></i>
                                        Pending
                                    </span>
                                    {% elif item.status == 'already_provided' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="bi bi-info-circle mr-1"></i>
                                        Already Provided
                                    </span>
                                    {% elif item.status == 'not_applicable' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <i class="bi bi-x-circle mr-1"></i>
                                        N/A
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
        <!-- Progress -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Progress</h3>
                <div class="mb-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Completion</span>
                        <span class="font-medium">{{ "%.0f"|format(checklist.progress_percentage) }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-cpa-green h-2 rounded-full" style="width: {{ checklist.progress_percentage }}%"></div>
                    </div>
                </div>
                <div class="text-xs text-gray-600">
                    Created {{ checklist.created_at.strftime('%b %d, %Y') }}
                </div>
            </div>
        </div>

        <!-- Client Portal -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Client Portal</h3>
                {% set client_user = checklist.client.client_users|first %}
                {% if client_user %}
                <div class="flex items-center p-2 bg-green-50 rounded">
                    <i class="bi bi-check-circle text-cpa-green"></i>
                    <div class="ml-2">
                        <p class="text-sm font-medium text-green-800">Active</p>
                        <p class="text-xs text-green-600">{{ client_user.access_code }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">No access</p>
                    <a href="{{ url_for('clients.client_access_setup', client_id=checklist.client_id) }}" 
                       class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded text-xs hover:bg-cpa-navy">
                        <i class="bi bi-gear mr-1"></i>
                        Setup
                    </a>
                </div>
                {% endif %}
            </div>
        </div>


        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Recent Activity</h3>
                <div class="space-y-2">
                    {% for item in checklist.items|sort(attribute='updated_at', reverse=true) %}
                        {% if loop.index <= 3 %}
                        <div class="flex items-start space-x-2">
                            <div class="w-1.5 h-1.5 bg-cpa-blue rounded-full mt-1.5"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-medium text-gray-900 truncate">{{ item.title }}</p>
                                <p class="text-xs text-gray-500">{{ item.status.replace('_', ' ').title() }}</p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<script>
let allDocuments = [];
let analysisResults = {};

// Initialize document list from the page
document.addEventListener('DOMContentLoaded', function() {
    // Collect all document IDs from the page
    const documentElements = document.querySelectorAll('[id^="document-content-"]');
    allDocuments = Array.from(documentElements).map(el => {
        const documentId = el.id.replace('document-content-', '');
        const filename = document.querySelector(`#expand-icon-${documentId}`).parentElement.parentElement.querySelector('h4').textContent;
        
        // Check if document is already analyzed
        const statusElement = document.getElementById(`analysis-status-${documentId}`);
        const isAnalyzed = statusElement && statusElement.textContent.trim() === 'Analyzed';
        
        return { 
            id: parseInt(documentId), 
            filename: filename,
            isAnalyzed: isAnalyzed
        };
    });
    
    // Load saved worksheet status
    loadSavedWorksheetStatus();
});

// Load saved worksheet status on page load
async function loadSavedWorksheetStatus() {
    const checklistId = {{ checklist.id }};
    
    try {
        const response = await fetch(`/api/saved-income-worksheet/${checklistId}`);
        const data = await response.json();
        
        if (data.saved) {
            updateWorksheetStatus({
                saved: true,
                worksheet_id: data.worksheet_id,
                filename: data.filename,
                generated_at: data.generated_at,
                file_size: data.file_size,
                is_recent: data.is_recent,
                action: 'loaded'
            });
        }
    } catch (error) {
        console.log('No saved worksheet found or error loading status:', error);
    }
}

// Store current worksheet ID for downloading
let currentWorksheetId = null;

// Update worksheet status UI
function updateWorksheetStatus(data) {
    const statusDiv = document.getElementById('worksheetStatus');
    const statusText = document.getElementById('worksheetStatusText');
    const btnText = document.getElementById('incomeWorksheetBtnText');
    
    if (data.saved) {
        const date = new Date(data.generated_at);
        const timeAgo = getTimeAgo(date);
        
        // Store worksheet ID for downloading
        currentWorksheetId = data.worksheet_id;
        
        statusDiv.classList.remove('hidden');
        
        if (data.action === 'created') {
            statusText.textContent = `Saved (${data.file_size})`;
            btnText.textContent = 'Income Worksheet';
        } else if (data.action === 'updated') {
            statusText.textContent = `Updated (${data.file_size})`;
            btnText.textContent = 'Income Worksheet';
        } else {
            statusText.textContent = `Saved ${timeAgo} (${data.file_size})`;
            btnText.textContent = 'Re-generate';
        }
        
        // Add tooltip with more info
        const statusButton = statusDiv.querySelector('button');
        statusButton.title = `Generated: ${date.toLocaleString()}\\nFilename: ${data.filename}\\nClick to download saved version`;
    } else {
        statusDiv.classList.add('hidden');
        btnText.textContent = 'Income Worksheet';
        currentWorksheetId = null;
    }
}

// Download saved worksheet function
async function downloadSavedWorksheet() {
    if (!currentWorksheetId) {
        alert('No saved worksheet available');
        return;
    }
    
    try {
        // Create a temporary link to download the saved worksheet
        const downloadUrl = `/download-saved-worksheet/${currentWorksheetId}`;
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = ''; // Let server determine filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Error downloading saved worksheet:', error);
        alert('Failed to download saved worksheet: ' + error.message);
    }
}

// Helper function to get human-readable time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// Toggle document expansion
function toggleDocumentExpansion(documentId) {
    const content = document.getElementById(`document-content-${documentId}`);
    const icon = document.getElementById(`expand-icon-${documentId}`);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-90');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-90');
    }
}

// Load cached analysis results and display in detailed format
async function loadCachedAnalysis(documentId) {
    const cachedDiv = document.getElementById(`cached-analysis-${documentId}`);
    if (!cachedDiv) return;
    
    try {
        const response = await fetch(`/api/document-analysis/${documentId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Use the same displayInlineAnalysis function but with cached indicator
        displayCachedInlineAnalysis(documentId, data);
        
    } catch (error) {
        console.error('Error loading cached analysis:', error);
        cachedDiv.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="bi bi-exclamation-triangle"></i>
                <p class="text-sm">Failed to load cached analysis</p>
            </div>
        `;
    }
}

// Display cached analysis results in the same detailed format as fresh results
function displayCachedInlineAnalysis(documentId, data) {
    const cachedDiv = document.getElementById(`cached-analysis-${documentId}`);
    
    let html = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Azure Extraction Results -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h4 class="font-semibold text-gray-900 border-b pb-2">Document Structure</h4>
                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                        <i class="bi bi-check-circle mr-1"></i>
                        Cached
                    </span>
                </div>
    `;
    
    if (data.azure_result && data.azure_result.key_value_pairs && data.azure_result.key_value_pairs.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Key-Value Pairs</h5>
                    <div class="bg-white rounded p-3 max-h-48 overflow-y-auto border">
        `;
        
        data.azure_result.key_value_pairs.slice(0, 15).forEach(pair => {
            html += `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-0">
                            <span class="font-medium text-gray-700">${pair.key || 'Unknown'}:</span>
                            <span class="text-gray-600">${pair.value || 'N/A'}</span>
                        </div>
            `;
        });
        
        html += `
                    </div>
                </div>
        `;
    }
    
    if (data.azure_result && data.azure_result.tables && data.azure_result.tables.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Tables Found</h5>
                    <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                        ${data.azure_result.tables.length} table(s) detected with ${data.azure_result.tables.reduce((sum, table) => sum + (table.cells?.length || 0), 0)} total cells
                    </div>
                </div>
        `;
    }
    
    html += `
            </div>
            
            <!-- Gemini Analysis Results -->
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">AI Analysis</h4>
    `;
    
    if (data.gemini_result) {
        if (data.gemini_result.document_type) {
            html += `
                <div class="bg-blue-50 rounded p-3 border border-blue-200">
                    <h5 class="font-medium text-blue-900">Document Type</h5>
                    <p class="text-blue-700 text-sm">${data.gemini_result.document_type}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.summary) {
            html += `
                <div class="bg-green-50 rounded p-3 border border-green-200">
                    <h5 class="font-medium text-green-900">Summary</h5>
                    <p class="text-green-700 text-sm">${data.gemini_result.summary}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.key_findings && data.gemini_result.key_findings.length > 0) {
            html += `
                <div class="bg-purple-50 rounded p-3 border border-purple-200">
                    <h5 class="font-medium text-purple-900">Key Findings</h5>
                    <ul class="text-purple-700 text-sm space-y-1 mt-2 max-h-32 overflow-y-auto">
            `;
            
            data.gemini_result.key_findings.slice(0, 8).forEach(finding => {
                html += `<li class="flex items-start"><i class="bi bi-check-circle-fill text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${finding}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
        
        if (data.gemini_result.recommendations && data.gemini_result.recommendations.length > 0) {
            html += `
                <div class="bg-amber-50 rounded p-3 border border-amber-200">
                    <h5 class="font-medium text-amber-900">AI Recommendations</h5>
                    <ul class="text-amber-700 text-sm space-y-1 mt-2">
            `;
            
            data.gemini_result.recommendations.slice(0, 3).forEach(rec => {
                html += `<li class="flex items-start"><i class="bi bi-lightbulb-fill text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${rec}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
    }
    
    html += `
            </div>
        </div>
        
        <!-- Document Visualization -->
        <div class="mt-6 border-t pt-4">
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold text-gray-900">Document Visualization</h4>
                <button onclick="showDocumentVisualization(${documentId})" 
                        class="px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                    <i class="bi bi-eye mr-1"></i>
                    View with Tick Marks
                </button>
            </div>
            <div id="visualization-${documentId}" class="hidden">
                <!-- Visualization will be loaded here -->
            </div>
        </div>
    `;
    
    cachedDiv.innerHTML = html;
}

// View full cached analysis results
async function viewFullAnalysis(documentId) {
    try {
        const response = await fetch(`/api/document-analysis/${documentId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Show full analysis in modal
        showAnalysisModal(data);
        
    } catch (error) {
        console.error('Error loading full analysis:', error);
        alert('Failed to load full analysis: ' + error.message);
    }
}

// Show analysis results in a modal
function showAnalysisModal(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">AI Analysis Results</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-medium text-gray-900">${data.filename}</h4>
                            <p class="text-sm text-gray-600">Status: ${data.status}</p>
                        </div>
                        ${data.cached ? `
                        <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="bi bi-check-circle mr-1"></i>
                            Cached Result
                        </span>
                        ` : ''}
                    </div>
                    
                    <!-- Azure Results -->
                    ${data.azure_result && Object.keys(data.azure_result).length > 0 ? `
                    <div class="border rounded-lg p-4">
                        <h5 class="font-medium text-gray-900 mb-3">Azure Document Intelligence</h5>
                        <div class="space-y-3">
                            ${data.azure_result.key_value_pairs && data.azure_result.key_value_pairs.length > 0 ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-2">Extracted Fields</h6>
                                <div class="grid grid-cols-2 gap-2">
                                    ${data.azure_result.key_value_pairs.map(pair => `
                                        <div class="text-sm">
                                            <span class="font-medium text-gray-600">${pair.key}:</span>
                                            <span class="text-gray-800">${pair.value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${data.azure_result.confidence ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-2">Confidence Score</h6>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${(data.azure_result.confidence * 100).toFixed(0)}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${(data.azure_result.confidence * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Gemini Results -->
                    ${data.gemini_result && Object.keys(data.gemini_result).length > 0 ? `
                    <div class="border rounded-lg p-4">
                        <h5 class="font-medium text-gray-900 mb-3">Google Gemini Analysis</h5>
                        <div class="space-y-3">
                            ${data.gemini_result.document_type ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-1">Document Type</h6>
                                <p class="text-sm text-gray-800">${data.gemini_result.document_type}</p>
                            </div>
                            ` : ''}
                            
                            ${data.gemini_result.summary ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-1">Summary</h6>
                                <p class="text-sm text-gray-800">${data.gemini_result.summary}</p>
                            </div>
                            ` : ''}
                            
                            ${data.gemini_result.key_findings && data.gemini_result.key_findings.length > 0 ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-2">Key Findings</h6>
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.gemini_result.key_findings.map(finding => `<li class="text-sm text-gray-800">${finding}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${data.gemini_result.recommendations && data.gemini_result.recommendations.length > 0 ? `
                            <div>
                                <h6 class="text-sm font-medium text-gray-700 mb-2">Recommendations</h6>
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.gemini_result.recommendations.map(rec => `<li class="text-sm text-gray-800">${rec}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${data.processing_notes ? `
                    <div class="text-xs text-gray-500 p-3 bg-gray-50 rounded">
                        ${data.processing_notes}
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Analyze all documents (always re-run analysis)
async function analyzeAllDocuments() {
    if (allDocuments.length === 0) {
        alert('No documents to analyze');
        return;
    }
    
    const progressElement = document.getElementById('bulkProgress');
    progressElement.classList.remove('hidden');
    
    try {
        let processedCount = 0;
        
        for (const doc of allDocuments) {
            // Update progress
            progressElement.querySelector('span').textContent = `Processing ${doc.filename} (${processedCount + 1}/${allDocuments.length})...`;
            
            // Update document status
            const statusElement = document.getElementById(`analysis-status-${doc.id}`);
            statusElement.textContent = 'Analyzing...';
            statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800';
            
            try {
                const result = await analyzeDocument(doc.id, doc.filename, false, true); // Don't show modal, force re-analysis
                analysisResults[doc.id] = result;
                
                // Update status to success
                statusElement.textContent = 'Analyzed';
                statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800';
                
                // Update the document content
                displayInlineAnalysis(doc.id, result);
                
                processedCount++;
                
            } catch (error) {
                console.error(`Failed to analyze ${doc.filename}:`, error);
                
                // Update status to error
                statusElement.textContent = 'Failed';
                statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                
                // Show error in document content
                const analysisDiv = document.getElementById(`document-analysis-${doc.id}`);
                analysisDiv.innerHTML = `
                    <div class="text-center py-4 text-red-600">
                        <i class="bi bi-exclamation-triangle text-xl mb-2"></i>
                        <p class="font-medium">Analysis Failed</p>
                        <p class="text-sm">${error.message || 'Unable to analyze document'}</p>
                    </div>
                `;
            }
        }
        
        progressElement.classList.add('hidden');
        alert(`Analysis complete! Processed ${processedCount}/${allDocuments.length} documents.`);
        
    } catch (error) {
        progressElement.classList.add('hidden');
        alert('Bulk analysis failed: ' + error.message);
    }
}

// Document analysis functionality (updated)
async function analyzeDocument(documentId, filename, showModal = true, forceReanalysis = false) {
    try {
        // Call the analysis API with force_reanalysis parameter if needed
        const url = forceReanalysis ? 
            `/api/document-analysis/${documentId}?force_reanalysis=true` : 
            `/api/document-analysis/${documentId}`;
            
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.message || data.details || data.error);
        }
        
        return data;
        
    } catch (error) {
        console.error('Analysis error:', error);
        throw error;
    }
}

// Display analysis results inline within document expansion
function displayInlineAnalysis(documentId, data) {
    const analysisDiv = document.getElementById(`document-analysis-${documentId}`);
    
    let html = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Azure Extraction Results -->
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Document Structure</h4>
    `;
    
    if (data.azure_result && data.azure_result.key_value_pairs && data.azure_result.key_value_pairs.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Key-Value Pairs</h5>
                    <div class="bg-white rounded p-3 max-h-48 overflow-y-auto border">
        `;
        
        data.azure_result.key_value_pairs.slice(0, 15).forEach(pair => {
            html += `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-0">
                            <span class="font-medium text-gray-700">${pair.key || 'Unknown'}:</span>
                            <span class="text-gray-600">${pair.value || 'N/A'}</span>
                        </div>
            `;
        });
        
        html += `
                    </div>
                </div>
        `;
    }
    
    if (data.azure_result && data.azure_result.tables && data.azure_result.tables.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Tables Found</h5>
                    <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                        ${data.azure_result.tables.length} table(s) detected with ${data.azure_result.tables.reduce((sum, table) => sum + (table.cells?.length || 0), 0)} total cells
                    </div>
                </div>
        `;
    }
    
    html += `
            </div>
            
            <!-- Gemini Analysis Results -->
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">AI Analysis</h4>
    `;
    
    if (data.gemini_result) {
        if (data.gemini_result.document_type) {
            html += `
                <div class="bg-blue-50 rounded p-3 border border-blue-200">
                    <h5 class="font-medium text-blue-900">Document Type</h5>
                    <p class="text-blue-700 text-sm">${data.gemini_result.document_type}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.summary) {
            html += `
                <div class="bg-green-50 rounded p-3 border border-green-200">
                    <h5 class="font-medium text-green-900">Summary</h5>
                    <p class="text-green-700 text-sm">${data.gemini_result.summary}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.key_findings && data.gemini_result.key_findings.length > 0) {
            html += `
                <div class="bg-purple-50 rounded p-3 border border-purple-200">
                    <h5 class="font-medium text-purple-900">Key Findings</h5>
                    <ul class="text-purple-700 text-sm space-y-1 mt-2 max-h-32 overflow-y-auto">
            `;
            
            data.gemini_result.key_findings.slice(0, 8).forEach(finding => {
                html += `<li class="flex items-start"><i class="bi bi-check-circle-fill text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${finding}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
        
        if (data.gemini_result.recommendations && data.gemini_result.recommendations.length > 0) {
            html += `
                <div class="bg-amber-50 rounded p-3 border border-amber-200">
                    <h5 class="font-medium text-amber-900">AI Recommendations</h5>
                    <ul class="text-amber-700 text-sm space-y-1 mt-2">
            `;
            
            data.gemini_result.recommendations.slice(0, 3).forEach(rec => {
                html += `<li class="flex items-start"><i class="bi bi-lightbulb-fill text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${rec}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
    }
    
    html += `
            </div>
        </div>
        
        <!-- Document Visualization -->
        <div class="mt-6 border-t pt-4">
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold text-gray-900">Document Visualization</h4>
                <button onclick="showDocumentVisualization(${documentId})" 
                        class="px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                    <i class="bi bi-eye mr-1"></i>
                    View with Tick Marks
                </button>
            </div>
            <div id="visualization-${documentId}" class="hidden">
                <!-- Visualization will be loaded here -->
            </div>
        </div>
    `;
    
    analysisDiv.innerHTML = html;
}

// Show document visualization with tick marks
async function showDocumentVisualization(documentId) {
    const vizDiv = document.getElementById(`visualization-${documentId}`);
    
    if (!vizDiv.classList.contains('hidden')) {
        vizDiv.classList.add('hidden');
        return;
    }
    
    vizDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="text-sm text-gray-600 mt-2">Creating visualization...</p>
        </div>
    `;
    vizDiv.classList.remove('hidden');
    
    try {
        const response = await fetch(`/create-document-visualization/${documentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // The visualization should return an image URL or embed
                vizDiv.innerHTML = `
                    <div class="border rounded-lg p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-green-600 font-medium">${result.message || 'Visualization ready'}</span>
                            <button onclick="this.parentElement.parentElement.parentElement.classList.add('hidden')" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <img src="/document-visualization/${documentId}?t=${Date.now()}" 
                             alt="Document with tick mark annotations" 
                             class="max-w-full h-auto rounded border"
                             onerror="this.parentElement.innerHTML='<p class=&quot;text-red-600&quot;>Failed to load visualization image</p>'" />
                        <p class="text-xs text-gray-500 mt-2">Green tick marks indicate detected fields and extracted data</p>
                    </div>
                `;
            } else {
                throw new Error(result.error || 'Visualization creation failed');
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || errorData.details || 'Failed to create visualization');
        }
    } catch (error) {
        console.error('Visualization error:', error);
        
        // Check if error suggests analyzing documents first
        const isAnalysisNeeded = error.message.includes('cached Azure analysis results') || 
                                  error.message.includes('analyze the document first');
        
        vizDiv.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="bi bi-exclamation-triangle mb-2"></i>
                <p class="text-sm font-medium">Failed to create visualization</p>
                <p class="text-xs text-gray-600 mt-1">${error.message}</p>
                ${isAnalysisNeeded ? `
                <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-blue-800">
                    <p class="text-xs font-medium">ðŸ’¡ Tip: Try clicking "Analyze All Documents" first</p>
                    <p class="text-xs">This will process the document and enable tick mark visualization</p>
                </div>
                ` : ''}
                <button onclick="this.parentElement.parentElement.classList.add('hidden')" 
                        class="mt-2 text-xs text-gray-500 hover:text-gray-700 underline">
                    Close
                </button>
            </div>
        `;
    }
}

// Export all documents using saved analysis results from database
async function exportAllDocuments() {
    const checklistId = {{ checklist.id }};
    
    try {
        const response = await fetch(`/api/export-checklist-analysis/${checklistId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || errorData.error || 'Failed to export analysis');
        }
        
        // Get the filename from the response headers
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'analysis_export.json';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        const exportData = await blob.text();
        const parsedData = JSON.parse(exportData);
        alert(`Analysis export completed successfully!\n\nDocuments exported: ${parsedData.document_count}\nFilename: ${filename}`);
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Export failed: ' + error.message);
    }
}

// Generate workpaper PDF using saved analysis results
async function generateWorkpaper() {
    const checklistId = {{ checklist.id }};
    
    try {
        // First check if we have any analyzed documents
        const checkResponse = await fetch(`/api/export-checklist-analysis/${checklistId}`, {
            method: 'GET'
        });
        
        if (!checkResponse.ok) {
            const errorData = await checkResponse.json();
            alert(errorData.message || 'No analysis results available. Please analyze documents first.');
            return;
        }
        
        const exportData = await checkResponse.json();
        
        // Transform export data to workpaper format
        const workpaperData = {
            documents: {},
            title: 'Tax Document Workpaper',
            client_name: exportData.client_name,
            tax_year: new Date().getFullYear().toString()
        };
        
        // Convert saved analysis results to workpaper format
        exportData.documents.forEach(doc => {
            workpaperData.documents[doc.document_id] = {
                filename: doc.filename,
                status: doc.processing_status,
                azure_result: doc.analysis_results?.azure_result || {},
                gemini_result: doc.analysis_results?.gemini_result || {},
                processing_notes: `Analyzed on ${doc.analysis_timestamp}`
            };
        });
        
        const response = await fetch('{{ url_for('ai.generate_bulk_workpaper') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(workpaperData)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workpaper_${exportData.client_name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert(`Workpaper generated successfully!\n\nDocuments included: ${exportData.document_count}\nClient: ${exportData.client_name}`);
        } else {
            throw new Error('Failed to generate workpaper');
        }
        
    } catch (error) {
        console.error('Workpaper generation error:', error);
        alert('Workpaper generation failed: ' + error.message);
    }
}

// Generate income worksheet CSV
async function generateIncomeWorksheet() {
    const checklistId = {{ checklist.id }};
    
    try {
        // Show loading state
        const button = document.getElementById('incomeWorksheetBtn');
        const btnText = document.getElementById('incomeWorksheetBtnText');
        const originalText = btnText.textContent;
        
        button.disabled = true;
        btnText.textContent = 'Generating...';
        button.querySelector('i').className = 'bi bi-hourglass-split mr-2';
        
        const response = await fetch(`/api/generate-income-worksheet/${checklistId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || errorData.error || 'Failed to generate income worksheet');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to generate income worksheet');
        }
        
        // Create and download CSV file
        const csvContent = result.csv_content;
        const filename = result.filename;
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Update status UI
        if (result.saved) {
            updateWorksheetStatus({
                saved: true,
                filename: result.filename,
                generated_at: result.generated_at,
                file_size: result.file_size,
                action: result.action
            });
        }
        
        // Show success message with save status
        let message = `Income worksheet generated successfully!\n\nDocuments processed: ${result.document_count}\nClient: ${result.client_name}\nFilename: ${filename}`;
        
        if (result.saved) {
            message += `\n\nâœ… Worksheet ${result.action} and saved to database`;
            if (result.action === 'updated') {
                message += '\n(Previous version was replaced)';
            }
        } else if (result.save_error) {
            message += '\n\nâš ï¸ Generated but not saved to database';
        }
        
        alert(message);
        
    } catch (error) {
        console.error('Income worksheet generation error:', error);
        alert('Income worksheet generation failed: ' + error.message);
    } finally {
        // Restore button state
        const button = document.getElementById('incomeWorksheetBtn');
        const btnText = document.getElementById('incomeWorksheetBtnText');
        
        button.disabled = false;
        button.querySelector('i').className = 'bi bi-file-earmark-spreadsheet mr-2';
        
        // Restore appropriate text (will be overridden by updateWorksheetStatus if successful)
        if (btnText.textContent === 'Generating...') {
            btnText.textContent = 'Income Worksheet';
        }
    }
}

console.log('Checklist dashboard with inline AI analysis loaded');
</script>

{% endblock %}