{% extends "base_modern.html" %}
{% set active_page = "checklists" %}

{% block title %}{{ checklist.name }} - {{ checklist.client.name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-1">
            <a href="{{ url_for('document_checklists') }}" class="hover:text-cpa-blue">Checklists</a>
            <i class="bi bi-chevron-right"></i>
            <span>{{ checklist.client.name }}</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">{{ checklist.name }}</h1>
    </div>
    <div class="flex space-x-3">
        <a href="{{ url_for('edit_checklist', checklist_id=checklist.id) }}" 
           class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-cpa-navy transition-colors">
            <i class="bi bi-pencil mr-2"></i>
            Edit Checklist
        </a>
        <a href="{{ url_for('client_access_setup', client_id=checklist.client_id) }}" 
           class="inline-flex items-center px-4 py-2 bg-cpa-green text-white rounded-lg hover:bg-green-600 transition-colors">
            <i class="bi bi-person-circle mr-2"></i>
            Setup Portal Access
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-gray-900">{{ checklist.items|length }}</p>
            <p class="text-xs text-gray-600">Total</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-amber-600">{{ checklist.items|selectattr('status', 'equalto', 'pending')|list|length }}</p>
            <p class="text-xs text-gray-600">Pending</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-cpa-green">{{ checklist.items|selectattr('status', 'equalto', 'uploaded')|list|length }}</p>
            <p class="text-xs text-gray-600">Uploaded</p>
        </div>
    </div>
    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
        <div class="text-center">
            <p class="text-lg font-bold text-cpa-blue">{{ "%.0f"|format(checklist.progress_percentage) }}%</p>
            <p class="text-xs text-gray-600">Complete</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2">
        <!-- Document Status -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 mb-6">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-900">Document Status</h2>
            </div>
            <!-- Bulk Actions Bar -->
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="analyzeAllDocuments()" 
                                class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                            <i class="bi bi-robot mr-2"></i>
                            Analyze All Documents
                        </button>
                        <button onclick="exportAllDocuments()" 
                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            <i class="bi bi-file-earmark-arrow-down mr-2"></i>
                            Export Analysis
                        </button>
                        <button onclick="generateWorkpaper()" 
                                class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            <i class="bi bi-file-earmark-pdf mr-2"></i>
                            Generate Workpaper
                        </button>
                    </div>
                    <div id="bulkProgress" class="hidden">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"></div>
                            <span class="text-sm text-gray-600">Processing documents...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents List -->
            <div class="p-4">
                <div class="space-y-4">
                    {% for item in checklist.items %}
                    {% if item.status == 'uploaded' %}
                    {% set documents = item.client_documents|list %}
                    {% if documents %}
                    {% for document in documents %}
                    <div class="border border-gray-200 rounded-lg">
                        <!-- Document Header (Clickable) -->
                        <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors" 
                             onclick="toggleDocumentExpansion({{ document.id }})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <i id="expand-icon-{{ document.id }}" class="bi bi-chevron-right text-gray-400 mr-2 transition-transform"></i>
                                        <div>
                                            <h4 class="font-medium text-gray-900">{{ document.original_filename }}</h4>
                                            <p class="text-sm text-gray-500">{{ item.title }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="analysis-status-{{ document.id }}" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                            Not Analyzed
                                        </span>
                                        {% if item.is_required %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                            Required
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">{{ document.uploaded_at.strftime('%m/%d/%Y %I:%M %p') }}</span>
                                    <a href="{{ url_for('download_document', document_id=document.id) }}" 
                                       class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded text-xs hover:bg-cpa-navy transition-colors">
                                        <i class="bi bi-download mr-1"></i>
                                        Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expandable Content -->
                        <div id="document-content-{{ document.id }}" class="hidden border-t border-gray-200 bg-gray-50">
                            <div class="p-4">
                                <div id="document-analysis-{{ document.id }}">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="bi bi-file-earmark-text text-2xl mb-2"></i>
                                        <p>Click "Analyze All Documents" to process this document</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Pending Items -->
                {% set pending_items = checklist.items|selectattr('status', 'ne', 'uploaded')|list %}
                {% if pending_items %}
                <div class="mt-8">
                    <h4 class="font-medium text-gray-900 mb-4">Pending Items</h4>
                    <div class="space-y-2">
                        {% for item in pending_items %}
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-medium text-gray-900">{{ item.title }}</h5>
                                    {% if item.description %}
                                    <p class="text-sm text-gray-500">{{ item.description }}</p>
                                    {% endif %}
                                </div>
                                <div class="flex items-center space-x-2">
                                    {% if item.is_required %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                        Required
                                    </span>
                                    {% endif %}
                                    {% if item.status == 'pending' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-clock mr-1"></i>
                                        Pending
                                    </span>
                                    {% elif item.status == 'already_provided' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="bi bi-info-circle mr-1"></i>
                                        Already Provided
                                    </span>
                                    {% elif item.status == 'not_applicable' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <i class="bi bi-x-circle mr-1"></i>
                                        N/A
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
        <!-- Progress -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Progress</h3>
                <div class="mb-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Completion</span>
                        <span class="font-medium">{{ "%.0f"|format(checklist.progress_percentage) }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-cpa-green h-2 rounded-full" style="width: {{ checklist.progress_percentage }}%"></div>
                    </div>
                </div>
                <div class="text-xs text-gray-600">
                    Created {{ checklist.created_at.strftime('%b %d, %Y') }}
                </div>
            </div>
        </div>

        <!-- Client Portal -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Client Portal</h3>
                {% set client_user = checklist.client.client_users|first %}
                {% if client_user %}
                <div class="flex items-center p-2 bg-green-50 rounded">
                    <i class="bi bi-check-circle text-cpa-green"></i>
                    <div class="ml-2">
                        <p class="text-sm font-medium text-green-800">Active</p>
                        <p class="text-xs text-green-600">{{ client_user.access_code }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">No access</p>
                    <a href="{{ url_for('client_access_setup', client_id=checklist.client_id) }}" 
                       class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded text-xs hover:bg-cpa-navy">
                        <i class="bi bi-gear mr-1"></i>
                        Setup
                    </a>
                </div>
                {% endif %}
            </div>
        </div>


        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-3">Recent Activity</h3>
                <div class="space-y-2">
                    {% for item in checklist.items|sort(attribute='updated_at', reverse=true) %}
                        {% if loop.index <= 3 %}
                        <div class="flex items-start space-x-2">
                            <div class="w-1.5 h-1.5 bg-cpa-blue rounded-full mt-1.5"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-medium text-gray-900 truncate">{{ item.title }}</p>
                                <p class="text-xs text-gray-500">{{ item.status.replace('_', ' ').title() }}</p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<script>
let allDocuments = [];
let analysisResults = {};

// Initialize document list from the page
document.addEventListener('DOMContentLoaded', function() {
    // Collect all document IDs from the page
    const documentElements = document.querySelectorAll('[id^="document-content-"]');
    allDocuments = Array.from(documentElements).map(el => {
        const documentId = el.id.replace('document-content-', '');
        const filename = document.querySelector(`#expand-icon-${documentId}`).parentElement.parentElement.querySelector('h4').textContent;
        return { id: parseInt(documentId), filename: filename };
    });
});

// Toggle document expansion
function toggleDocumentExpansion(documentId) {
    const content = document.getElementById(`document-content-${documentId}`);
    const icon = document.getElementById(`expand-icon-${documentId}`);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-90');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-90');
    }
}

// Analyze all documents
async function analyzeAllDocuments() {
    if (allDocuments.length === 0) {
        alert('No documents to analyze');
        return;
    }
    
    const progressElement = document.getElementById('bulkProgress');
    progressElement.classList.remove('hidden');
    
    try {
        let processedCount = 0;
        
        for (const doc of allDocuments) {
            // Update progress
            progressElement.querySelector('span').textContent = `Processing ${doc.filename} (${processedCount + 1}/${allDocuments.length})...`;
            
            // Update document status
            const statusElement = document.getElementById(`analysis-status-${doc.id}`);
            statusElement.textContent = 'Analyzing...';
            statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800';
            
            try {
                const result = await analyzeDocument(doc.id, doc.filename, false); // Don't show modal
                analysisResults[doc.id] = result;
                
                // Update status to success
                statusElement.textContent = 'Analyzed';
                statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800';
                
                // Update the document content
                displayInlineAnalysis(doc.id, result);
                
                processedCount++;
                
            } catch (error) {
                console.error(`Failed to analyze ${doc.filename}:`, error);
                
                // Update status to error
                statusElement.textContent = 'Failed';
                statusElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                
                // Show error in document content
                const analysisDiv = document.getElementById(`document-analysis-${doc.id}`);
                analysisDiv.innerHTML = `
                    <div class="text-center py-4 text-red-600">
                        <i class="bi bi-exclamation-triangle text-xl mb-2"></i>
                        <p class="font-medium">Analysis Failed</p>
                        <p class="text-sm">${error.message || 'Unable to analyze document'}</p>
                    </div>
                `;
            }
        }
        
        progressElement.classList.add('hidden');
        alert(`Analysis complete! Processed ${processedCount}/${allDocuments.length} documents.`);
        
    } catch (error) {
        progressElement.classList.add('hidden');
        alert('Bulk analysis failed: ' + error.message);
    }
}

// Document analysis functionality (updated)
async function analyzeDocument(documentId, filename, showModal = true) {
    try {
        // Call the analysis API
        const response = await fetch(`/api/document-analysis/${documentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.message || data.details || data.error);
        }
        
        return data;
        
    } catch (error) {
        console.error('Analysis error:', error);
        throw error;
    }
}

// Display analysis results inline within document expansion
function displayInlineAnalysis(documentId, data) {
    const analysisDiv = document.getElementById(`document-analysis-${documentId}`);
    
    let html = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Azure Extraction Results -->
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Document Structure</h4>
    `;
    
    if (data.azure_result && data.azure_result.key_value_pairs && data.azure_result.key_value_pairs.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Key-Value Pairs</h5>
                    <div class="bg-white rounded p-3 max-h-48 overflow-y-auto border">
        `;
        
        data.azure_result.key_value_pairs.slice(0, 15).forEach(pair => {
            html += `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-0">
                            <span class="font-medium text-gray-700">${pair.key || 'Unknown'}:</span>
                            <span class="text-gray-600">${pair.value || 'N/A'}</span>
                        </div>
            `;
        });
        
        html += `
                    </div>
                </div>
        `;
    }
    
    if (data.azure_result && data.azure_result.tables && data.azure_result.tables.length > 0) {
        html += `
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-700">Tables Found</h5>
                    <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                        ${data.azure_result.tables.length} table(s) detected with ${data.azure_result.tables.reduce((sum, table) => sum + (table.cells?.length || 0), 0)} total cells
                    </div>
                </div>
        `;
    }
    
    html += `
            </div>
            
            <!-- Gemini Analysis Results -->
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">AI Analysis</h4>
    `;
    
    if (data.gemini_result) {
        if (data.gemini_result.document_type) {
            html += `
                <div class="bg-blue-50 rounded p-3 border border-blue-200">
                    <h5 class="font-medium text-blue-900">Document Type</h5>
                    <p class="text-blue-700 text-sm">${data.gemini_result.document_type}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.summary) {
            html += `
                <div class="bg-green-50 rounded p-3 border border-green-200">
                    <h5 class="font-medium text-green-900">Summary</h5>
                    <p class="text-green-700 text-sm">${data.gemini_result.summary}</p>
                </div>
            `;
        }
        
        if (data.gemini_result.key_findings && data.gemini_result.key_findings.length > 0) {
            html += `
                <div class="bg-purple-50 rounded p-3 border border-purple-200">
                    <h5 class="font-medium text-purple-900">Key Findings</h5>
                    <ul class="text-purple-700 text-sm space-y-1 mt-2 max-h-32 overflow-y-auto">
            `;
            
            data.gemini_result.key_findings.slice(0, 8).forEach(finding => {
                html += `<li class="flex items-start"><i class="bi bi-check-circle-fill text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${finding}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
        
        if (data.gemini_result.recommendations && data.gemini_result.recommendations.length > 0) {
            html += `
                <div class="bg-amber-50 rounded p-3 border border-amber-200">
                    <h5 class="font-medium text-amber-900">AI Recommendations</h5>
                    <ul class="text-amber-700 text-sm space-y-1 mt-2">
            `;
            
            data.gemini_result.recommendations.slice(0, 3).forEach(rec => {
                html += `<li class="flex items-start"><i class="bi bi-lightbulb-fill text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i><span>${rec}</span></li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
    }
    
    html += `
            </div>
        </div>
        
        <!-- Document Visualization -->
        <div class="mt-6 border-t pt-4">
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold text-gray-900">Document Visualization</h4>
                <button onclick="showDocumentVisualization(${documentId})" 
                        class="px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                    <i class="bi bi-eye mr-1"></i>
                    View with Tick Marks
                </button>
            </div>
            <div id="visualization-${documentId}" class="hidden">
                <!-- Visualization will be loaded here -->
            </div>
        </div>
    `;
    
    analysisDiv.innerHTML = html;
}

// Show document visualization with tick marks
async function showDocumentVisualization(documentId) {
    const vizDiv = document.getElementById(`visualization-${documentId}`);
    
    if (!vizDiv.classList.contains('hidden')) {
        vizDiv.classList.add('hidden');
        return;
    }
    
    vizDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="text-sm text-gray-600 mt-2">Creating visualization...</p>
        </div>
    `;
    vizDiv.classList.remove('hidden');
    
    try {
        const response = await fetch(`/create-document-visualization/${documentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            // The visualization should return an image URL or embed
            vizDiv.innerHTML = `
                <div class="border rounded-lg p-4 bg-white">
                    <img src="/document-visualization/${documentId}" 
                         alt="Document with annotations" 
                         class="max-w-full h-auto rounded"
                         onerror="this.parentElement.innerHTML='<p class=&quot;text-red-600&quot;>Failed to load visualization</p>'" />
                </div>
            `;
        } else {
            throw new Error('Failed to create visualization');
        }
    } catch (error) {
        vizDiv.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="bi bi-exclamation-triangle"></i>
                <p class="text-sm">Failed to create visualization</p>
            </div>
        `;
    }
}

// Export all documents in Streamlit format
async function exportAllDocuments() {
    if (Object.keys(analysisResults).length === 0) {
        alert('No analysis results to export. Please analyze documents first.');
        return;
    }
    
    try {
        // Transform to Streamlit flat format
        const exportData = {
            export_date: new Date().toISOString(),
            document_count: Object.keys(analysisResults).length,
            documents: []
        };
        
        for (const [documentId, data] of Object.entries(analysisResults)) {
            const flatDoc = {
                filename: data.filename,
                processing_status: data.status || 'completed',
                processing_time: 0, // We don't track this currently
                document_id: documentId,
                created_at: new Date().toISOString(),
                processing_notes: data.processing_notes || '',
                
                // Flatten Azure results to top level
                doc_type: data.azure_result?.doc_type || 'unknown',
                confidence: data.azure_result?.confidence || 0,
                
                // Add Gemini categorization
                gemini_category: data.gemini_result?.document_type || 'Unknown',
                gemini_summary: data.gemini_result?.summary || '',
                
                validation_errors_count: 0
            };
            
            // Flatten Azure key-value pairs to top level
            if (data.azure_result && data.azure_result.key_value_pairs) {
                data.azure_result.key_value_pairs.forEach(pair => {
                    if (pair.key && pair.value) {
                        // Clean up key name for consistent format
                        const cleanKey = pair.key.replace(/[^a-zA-Z0-9]/g, '_');
                        flatDoc[cleanKey] = pair.value;
                    }
                });
            }
            
            // Add Gemini key findings with better field names
            if (data.gemini_result && data.gemini_result.key_findings) {
                data.gemini_result.key_findings.forEach((finding, index) => {
                    flatDoc[`key_finding_${index + 1}`] = finding;
                });
            }
            
            exportData.documents.push(flatDoc);
        }
        
        // Download as JSON
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `tax_documents_analysis_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
    } catch (error) {
        alert('Export failed: ' + error.message);
    }
}

// Generate workpaper PDF
async function generateWorkpaper() {
    if (Object.keys(analysisResults).length === 0) {
        alert('No analysis results available. Please analyze documents first.');
        return;
    }
    
    try {
        const response = await fetch('/generate-bulk-workpaper', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                documents: analysisResults,
                title: 'Tax Document Workpaper',
                client_name: 'Client Documents',
                tax_year: new Date().getFullYear().toString()
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workpaper_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            throw new Error('Failed to generate workpaper');
        }
        
    } catch (error) {
        alert('Workpaper generation failed: ' + error.message);
    }
}

console.log('Checklist dashboard with inline AI analysis loaded');
</script>

{% endblock %}