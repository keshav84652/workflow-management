{% extends "base_modern.html" %}
{% set active_page = "document_analysis" %}

{% block title %}Document Analysis - {{ client.name }}{% endblock %}

{% block content %}
<div x-data="documentAnalysis()" class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Document Analysis Results</h1>
            <p class="text-gray-600">AI-powered analysis for {{ client.name }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('view_client', id=client.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">
                <i class="bi bi-arrow-left mr-2"></i>
                Back to Client
            </a>
            <button type="button" 
                    @click="showWorkpaperModal = true"
                    :disabled="selectedDocuments.length === 0"
                    class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="bi bi-file-earmark-pdf mr-2"></i>
                Generate Workpaper
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Total Documents -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-cpa-blue rounded-lg flex items-center justify-center">
                    <i class="bi bi-file-earmark-text text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Documents</p>
                    <p class="text-2xl font-bold text-gray-900">{{ documents_with_analysis|length }}</p>
                </div>
            </div>
        </div>

        <!-- Analyzed -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-check-circle text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Analyzed</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ documents_with_analysis|selectattr('1')|selectattr('1.is_completed')|list|length }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Processing -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-hourglass-split text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Processing</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ documents_with_analysis|selectattr('1')|rejectattr('1.is_completed')|rejectattr('1.is_error')|list|length }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Workpapers -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-file-earmark-pdf text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Workpapers</p>
                    <p class="text-2xl font-bold text-gray-900">{{ workpaper_batches|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Document Analysis Results</h3>
            <div class="flex space-x-2">
                <button @click="analyzeAllDocuments()" 
                        :disabled="!hasUnanalyzedDocuments"
                        class="inline-flex items-center px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="bi bi-play-circle mr-2"></i>
                    Analyze All
                </button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            {% if documents_with_analysis %}
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" @change="toggleSelectAll" class="rounded border-gray-300 text-cpa-blue focus:ring-cpa-blue">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azure Analysis</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gemini Analysis</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for document, analysis in documents_with_analysis %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" 
                                   value="{{ document.id }}" 
                                   @change="toggleDocumentSelection({{ document.id }})"
                                   class="rounded border-gray-300 text-cpa-blue focus:ring-cpa-blue document-checkbox">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3
                                    {% if document.is_image %}bg-blue-100{% elif document.is_pdf %}bg-red-100{% else %}bg-gray-100{% endif %}">
                                    {% if document.is_image %}
                                        <i class="bi bi-image text-blue-600"></i>
                                    {% elif document.is_pdf %}
                                        <i class="bi bi-file-earmark-pdf text-red-600"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark text-gray-600"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ document.original_filename }}</div>
                                    <div class="text-sm text-gray-500">{{ document.file_size_formatted }} â€¢ {{ document.uploaded_at.strftime('%m/%d/%Y') }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if analysis %}
                                {% if analysis.is_completed %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="bi bi-check-circle mr-1"></i>Completed
                                    </span>
                                {% elif analysis.is_error %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>Error
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-hourglass-split mr-1"></i>Processing
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="bi bi-circle mr-1"></i>Not Analyzed
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if analysis and analysis.has_azure_results %}
                                <div>
                                    <div class="font-medium text-gray-900">{{ analysis.azure_doc_type }}</div>
                                    {% if analysis.azure_confidence %}
                                        <div class="text-sm text-gray-500">{{ "%.0f"|format(analysis.azure_confidence * 100) }}% confidence</div>
                                    {% endif %}
                                </div>
                            {% elif analysis and analysis.is_error %}
                                <span class="text-red-600">Analysis failed</span>
                            {% else %}
                                <span class="text-gray-400">No results</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if analysis and analysis.has_gemini_results %}
                                <div>
                                    <div class="font-medium text-gray-900">{{ analysis.gemini_document_category }}</div>
                                    {% if analysis.gemini_analysis_summary %}
                                        <div class="text-sm text-gray-500 truncate max-w-xs">{{ analysis.gemini_analysis_summary[:100] }}{% if analysis.gemini_analysis_summary|length > 100 %}...{% endif %}</div>
                                    {% endif %}
                                </div>
                            {% elif analysis and analysis.is_error %}
                                <span class="text-red-600">Analysis failed</span>
                            {% else %}
                                <span class="text-gray-400">No results</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if analysis and analysis.processing_duration %}
                                {{ "%.1f"|format(analysis.processing_duration) }}s
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" 
                                        class="inline-flex items-center px-3 py-1 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <div x-show="open" 
                                     @click.away="open = false"
                                     x-transition
                                     class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                                    {% if not analysis or analysis.is_error %}
                                    <button @click="analyzeDocument({{ document.id }}); open = false"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-play-circle mr-2"></i>Analyze
                                    </button>
                                    {% endif %}
                                    {% if analysis and analysis.is_completed %}
                                    <button @click="viewAnalysisDetails({{ analysis.id }}); open = false"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-eye mr-2"></i>View Details
                                    </button>
                                    {% endif %}
                                    <a href="{{ url_for('download_document', document_id=document.id) }}" 
                                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-download mr-2"></i>Download
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-12">
                <i class="bi bi-file-earmark-text text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Documents Found</h3>
                <p class="text-gray-500">This client hasn't uploaded any documents yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Workpaper Batches -->
    {% if workpaper_batches %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Generated Workpapers</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workpaper Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax Year</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documents</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for batch in workpaper_batches %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="font-medium text-gray-900">{{ batch.batch_name }}</div>
                                {% if batch.preparer_name %}
                                    <div class="text-sm text-gray-500">Prepared by: {{ batch.preparer_name }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.tax_year or '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.processed_documents }}/{{ batch.total_documents }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ batch.created_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if batch.is_completed %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="bi bi-check-circle mr-1"></i>Completed
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="bi bi-hourglass-split mr-1"></i>{{ batch.status.title() }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {% if batch.is_completed and batch.workpaper_file_path %}
                            <a href="{{ url_for('download_workpaper', batch_id=batch.id) }}" 
                               class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="bi bi-download mr-1"></i>Download
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Workpaper Generation Modal -->
    <div x-show="showWorkpaperModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
         style="display: none;">
        <div x-show="showWorkpaperModal"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Generate Workpaper</h3>
            </div>
            
            <form @submit.prevent="generateWorkpaper()" class="p-6 space-y-4">
                <input type="hidden" name="client_id" value="{{ client.id }}">
                
                <div>
                    <label for="batch_name" class="block text-sm font-medium text-gray-700 mb-1">Workpaper Name</label>
                    <input type="text" 
                           id="batch_name" 
                           name="batch_name" 
                           x-model="workpaperForm.batch_name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                           required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="tax_year" class="block text-sm font-medium text-gray-700 mb-1">Tax Year</label>
                        <input type="text" 
                               id="tax_year" 
                               name="tax_year" 
                               x-model="workpaperForm.tax_year"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                               placeholder="2024">
                    </div>
                    <div>
                        <label for="preparer_name" class="block text-sm font-medium text-gray-700 mb-1">Preparer Name</label>
                        <input type="text" 
                               id="preparer_name" 
                               name="preparer_name" 
                               x-model="workpaperForm.preparer_name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                               placeholder="John Doe, CPA">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selected Documents</label>
                    <div class="p-3 rounded-lg" 
                         :class="selectedDocuments.length > 0 ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'">
                        <p class="text-sm" 
                           :class="selectedDocuments.length > 0 ? 'text-green-700' : 'text-blue-700'">
                            <span x-show="selectedDocuments.length > 0">
                                <strong x-text="selectedDocuments.length"></strong> document(s) selected for workpaper generation.
                            </span>
                            <span x-show="selectedDocuments.length === 0">
                                Select documents from the table above to include in the workpaper.
                            </span>
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" 
                            @click="showWorkpaperModal = false"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="selectedDocuments.length === 0"
                            class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bi bi-file-earmark-pdf mr-2"></i>
                        Generate Workpaper
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analysis Details Modal -->
    <div x-show="showAnalysisModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
         style="display: none;">
        <div x-show="showAnalysisModal"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Analysis Details</h3>
                <button @click="showAnalysisModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="p-6" x-html="analysisDetails">
                <!-- Analysis details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function documentAnalysis() {
    return {
        selectedDocuments: [],
        showWorkpaperModal: false,
        showAnalysisModal: false,
        analysisDetails: '',
        workpaperForm: {
            batch_name: '{{ client.name }} Tax Documents 2024',
            tax_year: '2024',
            preparer_name: '{{ session.get("user_name", "") }}'
        },
        
        get hasUnanalyzedDocuments() {
            return document.querySelectorAll('.bg-gray-100.text-gray-800').length > 0;
        },
        
        toggleSelectAll(event) {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
                const docId = parseInt(checkbox.value);
                if (event.target.checked) {
                    if (!this.selectedDocuments.includes(docId)) {
                        this.selectedDocuments.push(docId);
                    }
                } else {
                    this.selectedDocuments = this.selectedDocuments.filter(id => id !== docId);
                }
            });
        },
        
        toggleDocumentSelection(documentId) {
            if (this.selectedDocuments.includes(documentId)) {
                this.selectedDocuments = this.selectedDocuments.filter(id => id !== documentId);
            } else {
                this.selectedDocuments.push(documentId);
            }
        },
        
        analyzeDocument(documentId) {
            fetch(`/analyze-document/${documentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showAlert('Document analysis started successfully', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    this.showAlert(data.error || 'Failed to start analysis', 'error');
                }
            })
            .catch(error => {
                this.showAlert('Error starting analysis: ' + error.message, 'error');
            });
        },
        
        analyzeAllDocuments() {
            const unanalyzedRows = document.querySelectorAll('tr:has(.bg-gray-100.text-gray-800)');
            let analysisPromises = [];
            
            unanalyzedRows.forEach(row => {
                const checkbox = row.querySelector('.document-checkbox');
                if (checkbox) {
                    const documentId = parseInt(checkbox.value);
                    analysisPromises.push(
                        fetch(`/analyze-document/${documentId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                    );
                }
            });
            
            if (analysisPromises.length > 0) {
                this.showAlert(`Starting analysis for ${analysisPromises.length} documents...`, 'info');
                Promise.all(analysisPromises)
                    .then(() => {
                        this.showAlert('All documents queued for analysis', 'success');
                        setTimeout(() => location.reload(), 3000);
                    })
                    .catch(error => {
                        this.showAlert('Some analyses failed to start', 'warning');
                    });
            } else {
                this.showAlert('No unanalyzed documents found', 'info');
            }
        },
        
        generateWorkpaper() {
            if (this.selectedDocuments.length === 0) {
                this.showAlert('Please select at least one document', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('client_id', '{{ client.id }}');
            formData.append('batch_name', this.workpaperForm.batch_name);
            formData.append('tax_year', this.workpaperForm.tax_year);
            formData.append('preparer_name', this.workpaperForm.preparer_name);
            
            this.selectedDocuments.forEach(docId => {
                formData.append('document_ids[]', docId);
            });
            
            fetch('/generate-workpaper', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showAlert('Workpaper generated successfully!', 'success');
                    this.showWorkpaperModal = false;
                    setTimeout(() => location.reload(), 2000);
                } else {
                    this.showAlert(data.error || 'Failed to generate workpaper', 'error');
                }
            })
            .catch(error => {
                this.showAlert('Error generating workpaper: ' + error.message, 'error');
            });
        },
        
        viewAnalysisDetails(analysisId) {
            fetch(`/api/analysis/${analysisId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    this.showAlert(data.error, 'error');
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">';
                
                // Azure Results
                if (data.azure_results) {
                    html += `
                        <div>
                            <h4 class="text-lg font-medium text-blue-600 mb-3">Azure Document Intelligence</h4>
                            <div class="space-y-3">
                                <div>
                                    <span class="font-medium text-gray-700">Document Type:</span>
                                    <span class="ml-2">${data.azure_results.doc_type}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Confidence:</span>
                                    <span class="ml-2">${Math.round(data.azure_results.confidence * 100)}%</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Extracted Fields:</span>
                                    <div class="mt-2 bg-gray-50 p-3 rounded-lg">
                                        <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(data.azure_results.fields, null, 2)}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Gemini Results
                if (data.gemini_results) {
                    html += `
                        <div>
                            <h4 class="text-lg font-medium text-green-600 mb-3">Gemini AI Analysis</h4>
                            <div class="space-y-3">
                                <div>
                                    <span class="font-medium text-gray-700">Category:</span>
                                    <span class="ml-2">${data.gemini_results.document_category}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Summary:</span>
                                    <div class="ml-2 mt-1">${data.gemini_results.analysis_summary}</div>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Extracted Information:</span>
                                    <div class="mt-2 bg-gray-50 p-3 rounded-lg">
                                        <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(data.gemini_results.extracted_info, null, 2)}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Validation Errors
                if (data.validation_errors && data.validation_errors.length > 0) {
                    html += `
                        <div class="mt-6">
                            <h4 class="text-lg font-medium text-yellow-600 mb-3">Validation Issues</h4>
                            <ul class="space-y-2">
                                ${data.validation_errors.map(error => `
                                    <li class="flex items-start text-${error.severity === 'error' ? 'red' : 'yellow'}-600">
                                        <i class="bi bi-exclamation-triangle mr-2 mt-0.5"></i>
                                        <span>${error.message}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                this.analysisDetails = html;
                this.showAnalysisModal = true;
            })
            .catch(error => {
                this.showAlert('Error loading analysis details: ' + error.message, 'error');
            });
        },
        
        showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white border-l-4 ${
                type === 'error' ? 'border-red-500' : 
                type === 'warning' ? 'border-yellow-500' : 
                type === 'info' ? 'border-blue-500' : 'border-green-500'
            } p-4 shadow-lg rounded-r-lg`;
            
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="bi bi-${
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        type === 'warning' ? 'exclamation-triangle text-yellow-500' : 
                        type === 'info' ? 'info-circle text-blue-500' : 'check-circle text-green-500'
                    } mr-2"></i>
                    <p class="text-sm text-gray-900">${message}</p>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    }
}
</script>
{% endblock %}