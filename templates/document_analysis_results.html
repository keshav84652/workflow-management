{% extends "base_modern.html" %}
{% set active_page = "document_analysis" %}

{% block title %}Document Analysis - {{ client.name }}{% endblock %}

{% block content %}
<div x-data="documentAnalysis()" class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Document Analysis Results</h1>
            <p class="text-gray-600">AI-powered analysis for {{ client.name }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('view_client', id=client.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">
                <i class="bi bi-arrow-left mr-2"></i>
                Back to Client
            </a>
            <button type="button" 
                    @click="showWorkpaperModal = true"
                    :disabled="selectedDocuments.length === 0"
                    class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="bi bi-file-earmark-pdf mr-2"></i>
                Generate Workpaper
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Total Documents -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-cpa-blue rounded-lg flex items-center justify-center">
                    <i class="bi bi-file-earmark-text text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Documents</p>
                    <p class="text-2xl font-bold text-gray-900">{{ documents_with_analysis|length }}</p>
                </div>
            </div>
        </div>

        <!-- Analyzed -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-check-circle text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Analyzed</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ documents_with_analysis|selectattr('1')|selectattr('1.is_completed')|list|length }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Processing -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-hourglass-split text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Processing</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ documents_with_analysis|selectattr('1')|rejectattr('1.is_completed')|rejectattr('1.is_error')|list|length }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Workpapers -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                    <i class="bi bi-file-earmark-pdf text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Workpapers</p>
                    <p class="text-2xl font-bold text-gray-900">{{ workpaper_batches|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Progress Indicator -->
    <div x-show="batchProgress.active" 
         class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6"
         style="display: none;">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium text-blue-900">Batch Processing Progress</h4>
            <span class="text-sm text-blue-700" x-text="`${batchProgress.completed} of ${batchProgress.total} completed`"></span>
        </div>
        <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                 :style="`width: ${batchProgress.percentage}%`"></div>
        </div>
        <div class="flex justify-between text-xs text-blue-600">
            <span x-text="`Processing: ${batchProgress.processing}`"></span>
            <span x-text="`Errors: ${batchProgress.errors}`"></span>
            <span x-text="`${batchProgress.percentage.toFixed(1)}% Complete`"></span>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Document Analysis Results</h3>
            <div class="flex space-x-2">
                <button @click="analyzeAllDocuments()" 
                        :disabled="!hasUnanalyzedDocuments"
                        class="inline-flex items-center px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="bi bi-play-circle mr-2"></i>
                    Analyze All
                </button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            {% if documents_with_analysis %}
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" @change="toggleSelectAll" class="rounded border-gray-300 text-cpa-blue focus:ring-cpa-blue">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azure Analysis</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gemini Analysis</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for document, analysis in documents_with_analysis %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" 
                                   value="{{ document.id }}" 
                                   @change="toggleDocumentSelection({{ document.id }})"
                                   class="rounded border-gray-300 text-cpa-blue focus:ring-cpa-blue document-checkbox">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3
                                    {% if document.is_image %}bg-blue-100{% elif document.is_pdf %}bg-red-100{% else %}bg-gray-100{% endif %}">
                                    {% if document.is_image %}
                                        <i class="bi bi-image text-blue-600"></i>
                                    {% elif document.is_pdf %}
                                        <i class="bi bi-file-earmark-pdf text-red-600"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark text-gray-600"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ document.original_filename }}</div>
                                    <div class="text-sm text-gray-500">{{ document.file_size_formatted }} â€¢ {{ document.uploaded_at.strftime('%m/%d/%Y') }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if analysis %}
                                {% if analysis.is_completed %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="bi bi-check-circle mr-1"></i>Completed
                                    </span>
                                {% elif analysis.is_error %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>Error
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-hourglass-split mr-1"></i>Processing
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="bi bi-circle mr-1"></i>Not Analyzed
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if analysis and analysis.has_azure_results %}
                                <div>
                                    <div class="font-medium text-gray-900">{{ analysis.azure_doc_type }}</div>
                                    {% if analysis.azure_confidence %}
                                        <div class="text-sm text-gray-500">{{ "%.0f"|format(analysis.azure_confidence * 100) }}% confidence</div>
                                    {% endif %}
                                </div>
                            {% elif analysis and analysis.is_error %}
                                <span class="text-red-600">Analysis failed</span>
                            {% else %}
                                <span class="text-gray-400">No results</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if analysis and analysis.has_gemini_results %}
                                <div>
                                    <div class="font-medium text-gray-900">{{ analysis.gemini_document_category }}</div>
                                    {% if analysis.gemini_analysis_summary %}
                                        <div class="text-sm text-gray-500 truncate max-w-xs">{{ analysis.gemini_analysis_summary[:100] }}{% if analysis.gemini_analysis_summary|length > 100 %}...{% endif %}</div>
                                    {% endif %}
                                </div>
                            {% elif analysis and analysis.is_error %}
                                <span class="text-red-600">Analysis failed</span>
                            {% else %}
                                <span class="text-gray-400">No results</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if analysis and analysis.processing_duration %}
                                {{ "%.1f"|format(analysis.processing_duration) }}s
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" 
                                        class="inline-flex items-center px-3 py-1 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <div x-show="open" 
                                     @click.away="open = false"
                                     x-transition
                                     class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                                    {% if not analysis or analysis.is_error %}
                                    <button @click="analyzeDocument({{ document.id }}); open = false"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-play-circle mr-2"></i>Analyze
                                    </button>
                                    {% endif %}
                                    {% if analysis and analysis.is_completed %}
                                    <button @click="viewAnalysisDetails({{ analysis.id }}); open = false"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-eye mr-2"></i>View Details
                                    </button>
                                    <button @click="viewDocumentWithAnnotations({{ document.id }}, {{ analysis.id }}); open = false"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-bullseye mr-2"></i>View with Annotations
                                    </button>
                                    {% endif %}
                                    <a href="{{ url_for('download_document', document_id=document.id) }}" 
                                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                        <i class="bi bi-download mr-2"></i>Download
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-12">
                <i class="bi bi-file-earmark-text text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Documents Found</h3>
                <p class="text-gray-500">This client hasn't uploaded any documents yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Workpaper Batches -->
    {% if workpaper_batches %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Generated Workpapers</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workpaper Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax Year</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documents</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for batch in workpaper_batches %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="font-medium text-gray-900">{{ batch.batch_name }}</div>
                                {% if batch.preparer_name %}
                                    <div class="text-sm text-gray-500">Prepared by: {{ batch.preparer_name }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.tax_year or '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.processed_documents }}/{{ batch.total_documents }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ batch.created_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if batch.is_completed %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="bi bi-check-circle mr-1"></i>Completed
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="bi bi-hourglass-split mr-1"></i>{{ batch.status.title() }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {% if batch.is_completed and batch.workpaper_file_path %}
                            <a href="{{ url_for('download_workpaper', batch_id=batch.id) }}" 
                               class="inline-flex items-center px-3 py-1 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="bi bi-download mr-1"></i>Download
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Workpaper Generation Modal -->
    <div x-show="showWorkpaperModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
         style="display: none;">
        <div x-show="showWorkpaperModal"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Generate Workpaper</h3>
            </div>
            
            <form @submit.prevent="generateWorkpaper()" class="p-6 space-y-4">
                <input type="hidden" name="client_id" value="{{ client.id }}">
                
                <div>
                    <label for="batch_name" class="block text-sm font-medium text-gray-700 mb-1">Workpaper Name</label>
                    <input type="text" 
                           id="batch_name" 
                           name="batch_name" 
                           x-model="workpaperForm.batch_name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                           required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="tax_year" class="block text-sm font-medium text-gray-700 mb-1">Tax Year</label>
                        <input type="text" 
                               id="tax_year" 
                               name="tax_year" 
                               x-model="workpaperForm.tax_year"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                               placeholder="2024">
                    </div>
                    <div>
                        <label for="preparer_name" class="block text-sm font-medium text-gray-700 mb-1">Preparer Name</label>
                        <input type="text" 
                               id="preparer_name" 
                               name="preparer_name" 
                               x-model="workpaperForm.preparer_name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-cpa-blue focus:border-cpa-blue"
                               placeholder="John Doe, CPA">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selected Documents</label>
                    <div class="p-3 rounded-lg" 
                         :class="selectedDocuments.length > 0 ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'">
                        <p class="text-sm" 
                           :class="selectedDocuments.length > 0 ? 'text-green-700' : 'text-blue-700'">
                            <span x-show="selectedDocuments.length > 0">
                                <strong x-text="selectedDocuments.length"></strong> document(s) selected for workpaper generation.
                            </span>
                            <span x-show="selectedDocuments.length === 0">
                                Select documents from the table above to include in the workpaper.
                            </span>
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" 
                            @click="showWorkpaperModal = false"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="selectedDocuments.length === 0"
                            class="inline-flex items-center px-4 py-2 bg-cpa-blue text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bi bi-file-earmark-pdf mr-2"></i>
                        Generate Workpaper
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analysis Details Modal -->
    <div x-show="showAnalysisModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
         style="display: none;">
        <div x-show="showAnalysisModal"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Analysis Details</h3>
                <button @click="showAnalysisModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="p-6" x-html="analysisDetails">
                <!-- Analysis details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function documentAnalysis() {
    return {
        selectedDocuments: [],
        showWorkpaperModal: false,
        showAnalysisModal: false,
        analysisDetails: '',
        workpaperForm: {
            batch_name: '{{ client.name }} Tax Documents 2024',
            tax_year: '2024',
            preparer_name: '{{ session.get("user_name", "") }}'
        },
        processingDocuments: new Set(),
        statusPollingInterval: null,
        batchProgressInterval: null,
        batchProgress: {
            active: false,
            total: 0,
            completed: 0,
            processing: 0,
            errors: 0,
            percentage: 0
        },
        
        init() {
            // Start status polling if there are processing documents
            this.checkForProcessingDocuments();
            if (this.processingDocuments.size > 0) {
                this.startStatusPolling();
            }
        },
        
        checkForProcessingDocuments() {
            // Check for documents that are currently processing
            const processingRows = document.querySelectorAll('tr:has(.bg-yellow-100)');
            processingRows.forEach(row => {
                const checkbox = row.querySelector('.document-checkbox');
                if (checkbox) {
                    this.processingDocuments.add(parseInt(checkbox.value));
                }
            });
        },
        
        startStatusPolling() {
            if (this.statusPollingInterval) return;
            
            this.statusPollingInterval = setInterval(() => {
                this.updateProcessingStatus();
            }, 5000); // Poll every 5 seconds
        },
        
        stopStatusPolling() {
            if (this.statusPollingInterval) {
                clearInterval(this.statusPollingInterval);
                this.statusPollingInterval = null;
            }
        },
        
        updateProcessingStatus() {
            if (this.processingDocuments.size === 0) {
                this.stopStatusPolling();
                return;
            }
            
            fetch(`/api/processing-status/{{ client.id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Status update error:', data.error);
                    return;
                }
                
                let hasChanges = false;
                
                data.documents.forEach(doc => {
                    if (this.processingDocuments.has(doc.document_id)) {
                        if (doc.status === 'completed' || doc.status === 'error') {
                            this.processingDocuments.delete(doc.document_id);
                            hasChanges = true;
                        }
                    }
                });
                
                if (hasChanges) {
                    // Reload the page to show updated status
                    location.reload();
                }
                
                if (this.processingDocuments.size === 0) {
                    this.stopStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
                // Don't stop polling on error, just log it
            });
        },
        
        startBatchProgress() {
            this.batchProgress.active = true;
            this.updateBatchProgress();
            
            // Update batch progress every 3 seconds
            if (!this.batchProgressInterval) {
                this.batchProgressInterval = setInterval(() => {
                    this.updateBatchProgress();
                }, 3000);
            }
        },
        
        updateBatchProgress() {
            fetch(`/api/batch-progress/{{ client.id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Batch progress error:', data.error);
                    return;
                }
                
                this.batchProgress.total = data.total_documents;
                this.batchProgress.completed = data.completed;
                this.batchProgress.processing = data.processing;
                this.batchProgress.errors = data.errors;
                this.batchProgress.percentage = data.progress_percentage;
                
                // Stop tracking if all processing is complete
                if (data.processing === 0 && this.batchProgress.active) {
                    setTimeout(() => {
                        this.batchProgress.active = false;
                        if (this.batchProgressInterval) {
                            clearInterval(this.batchProgressInterval);
                            this.batchProgressInterval = null;
                        }
                    }, 3000); // Show completed state for 3 seconds
                }
            })
            .catch(error => {
                console.error('Error updating batch progress:', error);
            });
        },
        
        get hasUnanalyzedDocuments() {
            return document.querySelectorAll('.bg-gray-100.text-gray-800').length > 0;
        },
        
        toggleSelectAll(event) {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
                const docId = parseInt(checkbox.value);
                if (event.target.checked) {
                    if (!this.selectedDocuments.includes(docId)) {
                        this.selectedDocuments.push(docId);
                    }
                } else {
                    this.selectedDocuments = this.selectedDocuments.filter(id => id !== docId);
                }
            });
        },
        
        toggleDocumentSelection(documentId) {
            if (this.selectedDocuments.includes(documentId)) {
                this.selectedDocuments = this.selectedDocuments.filter(id => id !== documentId);
            } else {
                this.selectedDocuments.push(documentId);
            }
        },
        
        analyzeDocument(documentId) {
            fetch(`/analyze-document/${documentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showAlert('Document analysis started successfully', 'success');
                    
                    // Add to processing set and start polling
                    this.processingDocuments.add(documentId);
                    this.startStatusPolling();
                    
                    // Don't reload immediately, let polling handle updates
                    // setTimeout(() => location.reload(), 2000);
                } else {
                    this.showAlert(data.error || 'Failed to start analysis', 'error');
                }
            })
            .catch(error => {
                this.showAlert('Error starting analysis: ' + error.message, 'error');
            });
        },
        
        analyzeAllDocuments() {
            const unanalyzedRows = document.querySelectorAll('tr:has(.bg-gray-100.text-gray-800)');
            let analysisPromises = [];
            let documentIds = [];
            
            unanalyzedRows.forEach(row => {
                const checkbox = row.querySelector('.document-checkbox');
                if (checkbox) {
                    const documentId = parseInt(checkbox.value);
                    documentIds.push(documentId);
                    analysisPromises.push(
                        fetch(`/analyze-document/${documentId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                    );
                }
            });
            
            if (analysisPromises.length > 0) {
                this.showAlert(`Starting analysis for ${analysisPromises.length} documents...`, 'info');
                
                Promise.all(analysisPromises)
                    .then(() => {
                        // Add all documents to processing set and start polling
                        documentIds.forEach(id => this.processingDocuments.add(id));
                        this.startStatusPolling();
                        this.startBatchProgress();
                        
                        this.showAlert('All documents queued for analysis', 'success');
                        // Don't reload immediately, let polling handle updates
                    })
                    .catch(error => {
                        this.showAlert('Some analyses failed to start', 'warning');
                    });
            } else {
                this.showAlert('No unanalyzed documents found', 'info');
            }
        },
        
        generateWorkpaper() {
            if (this.selectedDocuments.length === 0) {
                this.showAlert('Please select at least one document', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('client_id', '{{ client.id }}');
            formData.append('batch_name', this.workpaperForm.batch_name);
            formData.append('tax_year', this.workpaperForm.tax_year);
            formData.append('preparer_name', this.workpaperForm.preparer_name);
            
            this.selectedDocuments.forEach(docId => {
                formData.append('document_ids[]', docId);
            });
            
            fetch('/generate-workpaper', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showAlert('Workpaper generated successfully!', 'success');
                    this.showWorkpaperModal = false;
                    setTimeout(() => location.reload(), 2000);
                } else {
                    this.showAlert(data.error || 'Failed to generate workpaper', 'error');
                }
            })
            .catch(error => {
                this.showAlert('Error generating workpaper: ' + error.message, 'error');
            });
        },
        
        viewAnalysisDetails(analysisId) {
            fetch(`/api/analysis/${analysisId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    this.showAlert(data.error, 'error');
                    return;
                }
                
                let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">';
                
                // Azure Results
                if (data.azure_results) {
                    html += `
                        <div>
                            <h4 class="text-lg font-medium text-blue-600 mb-3">Azure Document Intelligence</h4>
                            <div class="space-y-3">
                                <div>
                                    <span class="font-medium text-gray-700">Document Type:</span>
                                    <span class="ml-2">${data.azure_results.doc_type}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Confidence:</span>
                                    <span class="ml-2">${Math.round(data.azure_results.confidence * 100)}%</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Extracted Fields:</span>
                                    <div class="mt-2 bg-gray-50 p-3 rounded-lg">
                                        <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(data.azure_results.fields, null, 2)}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Gemini Results
                if (data.gemini_results) {
                    html += `
                        <div>
                            <h4 class="text-lg font-medium text-green-600 mb-3">Gemini AI Analysis</h4>
                            <div class="space-y-3">
                                <div>
                                    <span class="font-medium text-gray-700">Category:</span>
                                    <span class="ml-2">${data.gemini_results.document_category}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Summary:</span>
                                    <div class="ml-2 mt-1">${data.gemini_results.analysis_summary}</div>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Extracted Information:</span>
                                    <div class="mt-2 bg-gray-50 p-3 rounded-lg">
                                        <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(data.gemini_results.extracted_info, null, 2)}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Validation Errors
                if (data.validation_errors && data.validation_errors.length > 0) {
                    html += `
                        <div class="mt-6">
                            <h4 class="text-lg font-medium text-yellow-600 mb-3">Validation Issues</h4>
                            <ul class="space-y-2">
                                ${data.validation_errors.map(error => `
                                    <li class="flex items-start text-${error.severity === 'error' ? 'red' : 'yellow'}-600">
                                        <i class="bi bi-exclamation-triangle mr-2 mt-0.5"></i>
                                        <span>${error.message}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                this.analysisDetails = html;
                this.showAnalysisModal = true;
            })
            .catch(error => {
                this.showAlert('Error loading analysis details: ' + error.message, 'error');
            });
        },
        
        viewDocumentWithAnnotations(documentId, analysisId) {
            // First create the visualization if it doesn't exist
            fetch(`/create-visualization/${analysisId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Open the document viewer modal with annotated image
                    this.showDocumentViewer(documentId, analysisId);
                } else {
                    this.showAlert(data.error || 'Failed to create visualization', 'error');
                }
            })
            .catch(error => {
                this.showAlert('Error creating visualization: ' + error.message, 'error');
            });
        },
        
        showDocumentViewer(documentId, analysisId) {
            // Create and show modal with document and annotations
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'documentModal';
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Document with Field Annotations</h3>
                        <button onclick="closeDocumentModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="bi bi-x-lg text-xl"></i>
                        </button>
                    </div>
                    <div class="max-h-screen-75 overflow-auto">
                        <div class="flex flex-col lg:flex-row gap-4">
                            <div class="flex-1">
                                <div class="border rounded-lg p-2 bg-gray-50">
                                    <img src="/annotated-image/${analysisId}" 
                                         alt="Document with annotations" 
                                         class="max-w-full h-auto cursor-zoom-in"
                                         onclick="toggleImageZoom(this)">
                                </div>
                                <div class="mt-2 text-sm text-gray-600 text-center">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    Orange boxes show extracted fields, green check marks indicate successful extraction
                                </div>
                            </div>
                            <div class="lg:w-1/3">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-medium text-gray-900 mb-3">Extraction Legend</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 border-2 border-orange-400 bg-orange-100 mr-2"></div>
                                            <span>Field boundaries (with labels)</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                                <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <span>Successfully extracted fields</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-3 border-t border-gray-200">
                                        <button onclick="downloadAnnotatedImage(${analysisId})" 
                                                class="w-full bg-cpa-blue text-white px-4 py-2 rounded-lg hover:bg-cpa-navy transition-colors">
                                            <i class="bi bi-download mr-2"></i>Download Annotated Image
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add global functions for modal interactions
            window.closeDocumentModal = () => {
                const modal = document.getElementById('documentModal');
                if (modal) modal.remove();
            };
            
            window.toggleImageZoom = (img) => {
                if (img.style.transform === 'scale(2)') {
                    img.style.transform = 'scale(1)';
                    img.style.cursor = 'zoom-in';
                } else {
                    img.style.transform = 'scale(2)';
                    img.style.cursor = 'zoom-out';
                }
            };
            
            window.downloadAnnotatedImage = (analysisId) => {
                window.open(`/annotated-image/${analysisId}`, '_blank');
            };
        },
        
        showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white border-l-4 ${
                type === 'error' ? 'border-red-500' : 
                type === 'warning' ? 'border-yellow-500' : 
                type === 'info' ? 'border-blue-500' : 'border-green-500'
            } p-4 shadow-lg rounded-r-lg`;
            
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="bi bi-${
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        type === 'warning' ? 'exclamation-triangle text-yellow-500' : 
                        type === 'info' ? 'info-circle text-blue-500' : 'check-circle text-green-500'
                    } mr-2"></i>
                    <p class="text-sm text-gray-900">${message}</p>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    }
}
</script>
{% endblock %}